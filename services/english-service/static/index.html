<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¨∏Ï†ú ÏÉùÏÑ± ÏòµÏÖò ÏÑ§Ï†ï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ratio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .ratio-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .range-value {
            font-weight: bold;
            color: #007bff;
            margin-left: 10px;
        }
        
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .submit-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            display: none;
        }
        
        .exam-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .exam-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .passage {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .question {
            background: #fff;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .question-number {
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .choices {
            margin-left: 20px;
        }
        
        .answer {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #28a745;
        }
        
        .explanation {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #007bff;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .error-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8d7da;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            display: none;
        }
        
        .passage-for-question, .example-for-question {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .passage-title, .example-title {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .passage-content, .example-content {
            line-height: 1.6;
            color: #333;
            margin-bottom: 10px;
        }
        
        .reference-note {
            background: #fffbf0;
            border: 1px solid #ffd700;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Î¨∏Ï†ú ÏÉùÏÑ± ÏòµÏÖò ÏÑ§Ï†ï</h1>
        
        <form id="questionForm">
            <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
            <div class="form-section">
                <div class="section-title">üìñ Í∏∞Î≥∏ Ï†ïÎ≥¥</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="schoolLevel">ÌïôÍµêÍ∏â</label>
                        <select id="schoolLevel" name="school_level" required>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            <option value="Ï§ëÌïôÍµê">Ï§ëÌïôÍµê</option>
                            <option value="Í≥†Îì±ÌïôÍµê">Í≥†Îì±ÌïôÍµê</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade">ÌïôÎÖÑ</label>
                        <select id="grade" name="grade" required>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            <option value="1">1ÌïôÎÖÑ</option>
                            <option value="2">2ÌïôÎÖÑ</option>
                            <option value="3">3ÌïôÎÖÑ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="totalQuestions">Ï¥ù Î¨∏Ï†ú Ïàò</label>
                        <input type="number" id="totalQuestions" name="total_questions" min="1" max="100" value="20" required>
                    </div>
                </div>
            </div>

            <!-- ÏòÅÏó≠ ÏÑ†ÌÉù -->
            <div class="form-section">
                <div class="section-title">üìù ÏòÅÏó≠ ÏÑ†ÌÉù</div>
                <div class="form-group">
                    <label>Ï£ºÏöî ÏòÅÏó≠ (Ï§ëÎ≥µ ÏÑ†ÌÉù Í∞ÄÎä•)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_reading" value="ÎèÖÌï¥" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_reading">ÎèÖÌï¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_grammar" value="Î¨∏Î≤ï" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_grammar">Î¨∏Î≤ï</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_vocabulary" value="Ïñ¥Ìúò" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_vocabulary">Ïñ¥Ìúò</label>
                        </div>
                    </div>
                </div>
                
                <div id="subjectDetails" style="margin-top: 20px;">
                    <!-- ÏÑ∏Î∂Ä ÏòÅÏó≠ÏùÄ JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
                </div>
            </div>

            <!-- Î¨∏Ï†ú ÎπÑÏú® -->
            <div class="form-section">
                <div class="section-title">‚öñÔ∏è ÏòÅÏó≠Î≥Ñ Î¨∏Ï†ú ÎπÑÏú®</div>
                <div id="subjectRatios" class="ratio-group">
                    <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    Ï¥ù ÎπÑÏú®: <span id="totalRatio">0</span>% (100%Í∞Ä ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§)
                </div>
            </div>

            <!-- Î¨∏Ï†ú ÌòïÏãù -->
            <div class="form-section">
                <div class="section-title">üìã Î¨∏Ï†ú ÌòïÏãù</div>
                <div class="form-group">
                    <label for="questionFormat">Î¨∏Ï†ú ÌòïÏãù</label>
                    <select id="questionFormat" name="question_format" required>
                        <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        <option value="Ï†ÑÏ≤¥">Ï†ÑÏ≤¥</option>
                        <option value="Í∞ùÍ¥ÄÏãù">Í∞ùÍ¥ÄÏãù</option>
                        <option value="Ï£ºÍ¥ÄÏãù">Ï£ºÍ¥ÄÏãù</option>
                        <option value="ÏÑúÏà†Ìòï">ÏÑúÏà†Ìòï</option>
                    </select>
                </div>
                
                <div id="formatCounts" style="margin-top: 20px;">
                    <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
                </div>
            </div>

            <!-- ÎÇúÏù¥ÎèÑ Î∂ÑÎ∞∞ -->
            <div class="form-section">
                <div class="section-title">üéØ ÎÇúÏù¥ÎèÑ Î∂ÑÎ∞∞</div>
                <div class="ratio-group">
                    <div class="ratio-item">
                        <label for="difficultyHigh">ÏÉÅ (Ïñ¥Î†§ÏõÄ)</label>
                        <input type="range" id="difficultyHigh" min="0" max="100" value="30" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyHighNum" min="0" max="100" value="30" oninput="syncDifficultyRatio('difficultyHigh')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyHighValue">30%</span>
                    </div>
                    <div class="ratio-item">
                        <label for="difficultyMedium">Ï§ë (Î≥¥ÌÜµ)</label>
                        <input type="range" id="difficultyMedium" min="0" max="100" value="50" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyMediumNum" min="0" max="100" value="50" oninput="syncDifficultyRatio('difficultyMedium')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyMediumValue">50%</span>
                    </div>
                    <div class="ratio-item">
                        <label for="difficultyLow">Ìïò (Ïâ¨ÏõÄ)</label>
                        <input type="range" id="difficultyLow" min="0" max="100" value="20" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyLowNum" min="0" max="100" value="20" oninput="syncDifficultyRatio('difficultyLow')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyLowValue">20%</span>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    Ï¥ù ÎÇúÏù¥ÎèÑ ÎπÑÏú®: <span id="totalDifficultyRatio">100</span>% (100%Í∞Ä ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§)
                </div>
            </div>

            <!-- Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠ -->
            <div class="form-section">
                <h3>üìù Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</h3>
                <div class="input-group">
                    <label for="additionalRequirements">ÌäπÎ≥ÑÌïú ÏöîÍµ¨ÏÇ¨Ìï≠Ïù¥ ÏûàÎã§Î©¥ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:</label>
                    <textarea 
                        id="additionalRequirements" 
                        name="additionalRequirements"
                        placeholder="Ïòà: ÌäπÏ†ï Ï£ºÏ†úÎÇò ÏÉÅÌô©ÏùÑ Ìè¨Ìï®Ìï¥Ï£ºÏÑ∏Ïöî, Î¨∏Ï†ú Ïä§ÌÉÄÏùº ÏöîÏ≤≠, ÌäπÎ≥ÑÌïú ÌòïÏãù Îì±..."
                        style="width: 100%; height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                    ></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        üí° ÏòàÏãú: "ÌïôÍµêÏÉùÌôúÍ≥º Í¥ÄÎ†®Îêú ÏÉÅÌô©ÏùÑ Ìè¨Ìï®Ìï¥Ï£ºÏÑ∏Ïöî", "ÎåÄÌôîÎ¨∏ ÏúÑÏ£ºÎ°ú Î¨∏Ï†úÎ•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî", "Ïã§ÏÉùÌôú ÏòàÏãúÎ•º ÎßéÏù¥ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî" Îì±
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button type="button" class="submit-btn" onclick="generateExam()" style="background: linear-gradient(45deg, #28a745, #20c997);">üöÄ Î¨∏Ï†úÏßÄ ÏÉùÏÑ±</button>
            </div>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...</p>
        </div>

        <div class="result-section" id="result">
            <h3>‚úÖ Ï†úÏ∂ú ÏÑ±Í≥µ!</h3>
            <pre id="resultData"></pre>
        </div>

        <div class="error-section" id="error">
            <h3>‚ùå Ïò§Î•ò Î∞úÏÉù</h3>
            <pre id="errorData"></pre>
        </div>

        <div class="result-section" id="examResult" style="display: none;">
            <h3>üéâ Î¨∏Ï†úÏßÄ ÏÉùÏÑ± ÏôÑÎ£å!</h3>
            <div id="examContent">
                <!-- ÏÉùÏÑ±Îêú Î¨∏Ï†úÏßÄ ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <script>
        let categories = {};

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function loadCategories() {
            try {
                const response = await fetch('/categories');
                categories = await response.json();
                console.log('Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìúÎê®:', categories);
            } catch (error) {
                console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÌòÑÏû¨ ÏÑ†ÌÉù ÏÉÅÌÉúÎ•º Ï†ÄÏû•Ìï† Í∞ùÏ≤¥
        let selectedDetails = {
            reading_types: [],
            grammar_categories: [],
            grammar_topics: {},
            vocabulary_categories: []
        };

        // ÏòÅÏó≠ ÏÑ†ÌÉùÏóê Îî∞Î•∏ ÏÑ∏Î∂Ä ÏòÅÏó≠ ÌëúÏãú
        function updateSubjectDetails() {
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÑ∏Î∂Ä Ìï≠Î™©Îì§ÏùÑ Ï†ÄÏû•
            saveCurrentSelections();
            
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });
            
            const detailsDiv = document.getElementById('subjectDetails');
            
            if (selectedSubjects.length === 0) {
                detailsDiv.innerHTML = '';
                return;
            }

            let html = '<div class="section-title">ÏÑ∏Î∂Ä ÏòÅÏó≠ ÏÑ†ÌÉù</div>';
            
            // ÎèÖÌï¥Í∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
            if (selectedSubjects.includes('ÎèÖÌï¥') && categories.reading_types) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">üìñ ÎèÖÌï¥ Ïú†Ìòï</h4>';
                html += '<div class="checkbox-group">';
                categories.reading_types.forEach(type => {
                    const isChecked = selectedDetails.reading_types.includes(type.name) ? 'checked' : '';
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="reading_${type.id}" value="${type.name}" name="reading_types" ${isChecked}>
                            <label for="reading_${type.id}">${type.name}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // Î¨∏Î≤ïÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
            if (selectedSubjects.includes('Î¨∏Î≤ï') && categories.grammar_categories) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">üìù Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨</h4>';
                categories.grammar_categories.forEach(cat => {
                    const isCatChecked = selectedDetails.grammar_categories.includes(cat.name) ? 'checked' : '';
                    const topicsVisible = selectedDetails.grammar_categories.includes(cat.name) ? 'block' : 'none';
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                            <div class="checkbox-item" style="margin-bottom: 10px;">
                                <input type="checkbox" id="grammar_cat_${cat.id}" value="${cat.name}" name="grammar_categories" onchange="toggleGrammarTopics(${cat.id})" ${isCatChecked}>
                                <label for="grammar_cat_${cat.id}" style="font-weight: bold;">${cat.name}</label>
                            </div>
                            <div id="grammar_topics_${cat.id}" style="margin-left: 20px; display: ${topicsVisible};">
                                <div class="checkbox-group">
                    `;
                    if (cat.topics && cat.topics.length > 0) {
                        cat.topics.forEach(topic => {
                            const isTopicChecked = selectedDetails.grammar_topics.includes(topic.name) ? 'checked' : '';
                            html += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="topic_${topic.id}" value="${topic.name}" name="grammar_topics_${cat.id}" ${isTopicChecked}>
                                    <label for="topic_${topic.id}">${topic.name}</label>
                                </div>
                            `;
                        });
                    }
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Ïñ¥ÌúòÍ∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
            if (selectedSubjects.includes('Ïñ¥Ìúò') && categories.vocabulary_categories) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">üìö Ïñ¥Ìúò Ïπ¥ÌÖåÍ≥†Î¶¨</h4>';
                html += '<div class="checkbox-group">';
                categories.vocabulary_categories.forEach(cat => {
                    const isChecked = selectedDetails.vocabulary_categories.includes(cat.name) ? 'checked' : '';
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="vocab_${cat.id}" value="${cat.name}" name="vocabulary_categories" ${isChecked}>
                            <label for="vocab_${cat.id}">${cat.name}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            detailsDiv.innerHTML = html;
        }

        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÑ∏Î∂Ä Ìï≠Î™©Îì§ÏùÑ Ï†ÄÏû•ÌïòÎäî Ìï®Ïàò
        function saveCurrentSelections() {
            // ÎèÖÌï¥ Ïú†Ìòï Ï†ÄÏû• (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            selectedDetails.reading_types = [];
            document.querySelectorAll('input[name="reading_types"]:checked').forEach(cb => {
                selectedDetails.reading_types.push(cb.value);
            });
            
            // Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÄÏû• (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            selectedDetails.grammar_categories = [];
            document.querySelectorAll('input[name="grammar_categories"]:checked').forEach(cb => {
                selectedDetails.grammar_categories.push(cb.value);
            });
            
            // Î¨∏Î≤ï ÌÜ†ÌîΩ Ï†ÄÏû• (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            selectedDetails.grammar_topics = [];
            document.querySelectorAll('input[name^="grammar_topics_"]:checked').forEach(cb => {
                selectedDetails.grammar_topics.push(cb.value);
            });
            
            // Ïñ¥Ìúò Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÄÏû• (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            selectedDetails.vocabulary_categories = [];
            document.querySelectorAll('input[name="vocabulary_categories"]:checked').forEach(cb => {
                selectedDetails.vocabulary_categories.push(cb.value);
            });
        }

        // Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïãú ÌÜ†ÌîΩ ÌëúÏãú/Ïà®ÍπÄ
        function toggleGrammarTopics(categoryId) {
            const checkbox = document.getElementById(`grammar_cat_${categoryId}`);
            const topicsDiv = document.getElementById(`grammar_topics_${categoryId}`);
            
            if (checkbox.checked) {
                topicsDiv.style.display = 'block';
            } else {
                topicsDiv.style.display = 'none';
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìï¥Ï†ú Ïãú Ìï¥Îãπ ÌÜ†ÌîΩÎì§ÎèÑ Î™®Îëê Ìï¥Ï†ú
                const topicCheckboxes = topicsDiv.querySelectorAll('input[type="checkbox"]');
                topicCheckboxes.forEach(cb => cb.checked = false);
            }
        }

        // ÏòÅÏó≠Î≥Ñ ÎπÑÏú® ÏóÖÎç∞Ïù¥Ìä∏
        function updateSubjectRatios() {
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });
            
            const ratiosDiv = document.getElementById('subjectRatios');
            
            if (selectedSubjects.length === 0) {
                ratiosDiv.innerHTML = '';
                return;
            }

            let html = '';
            const defaultRatio = Math.floor(100 / selectedSubjects.length);
            const remainder = 100 % selectedSubjects.length;
            
            selectedSubjects.forEach((subject, index) => {
                const ratio = index === 0 ? defaultRatio + remainder : defaultRatio;
                html += `
                    <div class="ratio-item">
                        <label for="ratio${subject}">${subject} ÎπÑÏú®</label>
                        <input type="range" id="ratio${subject}" min="0" max="100" value="${ratio}" oninput="updateTotalRatio()">
                        <input type="number" id="ratio${subject}Num" min="0" max="100" value="${ratio}" oninput="syncSubjectRatio('ratio${subject}')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="ratio${subject}Value">${ratio}%</span>
                    </div>
                `;
            });
            
            ratiosDiv.innerHTML = html;
            updateTotalRatio();
        }

        // Ï¥ù ÎπÑÏú® Í≥ÑÏÇ∞
        function updateTotalRatio() {
            const ranges = document.querySelectorAll('#subjectRatios input[type="range"]');
            let total = 0;
            
            ranges.forEach(range => {
                const value = parseInt(range.value);
                total += value;
                
                // Ïä¨ÎùºÏù¥Îçî Í∞íÏùÑ Ïà´Ïûê ÏûÖÎ†•ÎûÄÏóê ÎèôÍ∏∞Ìôî
                const numberInput = document.getElementById(range.id + 'Num');
                if (numberInput) {
                    numberInput.value = value;
                }
                
                // ÌçºÏÑºÌä∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                const valueSpan = document.getElementById(range.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = value + '%';
                }
            });
            
            document.getElementById('totalRatio').textContent = total;
            document.getElementById('totalRatio').style.color = total === 100 ? '#28a745' : '#dc3545';
        }

        // Ïà´Ïûê ÏûÖÎ†•ÏóêÏÑú ÏòÅÏó≠Î≥Ñ Ïä¨ÎùºÏù¥ÎçîÎ°ú ÎèôÍ∏∞Ìôî
        function syncSubjectRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateTotalRatio();
            }
        }

        // Î¨∏Ï†ú ÌòïÏãùÎ≥Ñ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
        function updateFormatCounts() {
            const format = document.getElementById('questionFormat').value;
            const countsDiv = document.getElementById('formatCounts');
            const totalQuestions = parseInt(document.getElementById('totalQuestions').value) || 20;
            
            if (!format || format === 'Ï†ÑÏ≤¥') {
                countsDiv.innerHTML = `
                    <div class="section-title">ÌòïÏãùÎ≥Ñ Î¨∏Ï†ú ÎπÑÏú®</div>
                    <div class="ratio-group">
                        <div class="ratio-item">
                            <label for="ratioMultiple">Í∞ùÍ¥ÄÏãù</label>
                            <input type="range" id="ratioMultiple" min="0" max="100" value="60" oninput="updateFormatRatio()">
                            <input type="number" id="ratioMultipleNum" min="0" max="100" value="60" oninput="syncFormatRatio('ratioMultiple')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioMultipleValue">60%</span>
                        </div>
                        <div class="ratio-item">
                            <label for="ratioShort">Ï£ºÍ¥ÄÏãù</label>
                            <input type="range" id="ratioShort" min="0" max="100" value="30" oninput="updateFormatRatio()">
                            <input type="number" id="ratioShortNum" min="0" max="100" value="30" oninput="syncFormatRatio('ratioShort')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioShortValue">30%</span>
                        </div>
                        <div class="ratio-item">
                            <label for="ratioEssay">ÏÑúÏà†Ìòï</label>
                            <input type="range" id="ratioEssay" min="0" max="100" value="10" oninput="updateFormatRatio()">
                            <input type="number" id="ratioEssayNum" min="0" max="100" value="10" oninput="syncFormatRatio('ratioEssay')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioEssayValue">10%</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        Ï¥ù ÎπÑÏú®: <span id="totalFormatRatio">100</span>% / 100%
                    </div>
                `;
            } else {
                countsDiv.innerHTML = `
                    <div class="section-title">Î¨∏Ï†ú Ïàò</div>
                    <div class="ratio-item">
                        <label for="countSingle">${format} Î¨∏Ï†ú Ïàò</label>
                        <input type="number" id="countSingle" min="0" max="${totalQuestions}" value="${totalQuestions}" readonly>
                    </div>
                `;
            }
            updateFormatRatio();
        }

        // ÌòïÏãùÎ≥Ñ ÎπÑÏú® ÏóÖÎç∞Ïù¥Ìä∏
        function updateFormatRatio() {
            const ratioMultiple = parseInt(document.getElementById('ratioMultiple')?.value) || 0;
            const ratioShort = parseInt(document.getElementById('ratioShort')?.value) || 0;
            const ratioEssay = parseInt(document.getElementById('ratioEssay')?.value) || 0;
            
            // Ïä¨ÎùºÏù¥Îçî Í∞íÏùÑ Ïà´Ïûê ÏûÖÎ†•ÎûÄÏóê ÎèôÍ∏∞Ìôî
            const multipleNum = document.getElementById('ratioMultipleNum');
            const shortNum = document.getElementById('ratioShortNum');
            const essayNum = document.getElementById('ratioEssayNum');
            
            if (multipleNum) multipleNum.value = ratioMultiple;
            if (shortNum) shortNum.value = ratioShort;
            if (essayNum) essayNum.value = ratioEssay;
            
            // ÌçºÏÑºÌä∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const multipleValue = document.getElementById('ratioMultipleValue');
            const shortValue = document.getElementById('ratioShortValue');
            const essayValue = document.getElementById('ratioEssayValue');
            
            if (multipleValue) multipleValue.textContent = ratioMultiple + '%';
            if (shortValue) shortValue.textContent = ratioShort + '%';
            if (essayValue) essayValue.textContent = ratioEssay + '%';
            
            const total = ratioMultiple + ratioShort + ratioEssay;
            
            const totalSpan = document.getElementById('totalFormatRatio');
            if (totalSpan) {
                totalSpan.textContent = total;
                totalSpan.style.color = total === 100 ? '#28a745' : '#dc3545';
            }
        }

        // Ïà´Ïûê ÏûÖÎ†•ÏóêÏÑú Ïä¨ÎùºÏù¥ÎçîÎ°ú ÎèôÍ∏∞Ìôî
        function syncFormatRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateFormatRatio();
            }
        }

        // ÎÇúÏù¥ÎèÑ ÎπÑÏú® ÏóÖÎç∞Ïù¥Ìä∏
        function updateDifficultyRatio() {
            const high = parseInt(document.getElementById('difficultyHigh').value);
            const medium = parseInt(document.getElementById('difficultyMedium').value);
            const low = parseInt(document.getElementById('difficultyLow').value);
            
            // Ïä¨ÎùºÏù¥Îçî Í∞íÏùÑ Ïà´Ïûê ÏûÖÎ†•ÎûÄÏóê ÎèôÍ∏∞Ìôî
            const highNum = document.getElementById('difficultyHighNum');
            const mediumNum = document.getElementById('difficultyMediumNum');
            const lowNum = document.getElementById('difficultyLowNum');
            
            if (highNum) highNum.value = high;
            if (mediumNum) mediumNum.value = medium;
            if (lowNum) lowNum.value = low;
            
            // ÌçºÏÑºÌä∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('difficultyHighValue').textContent = high + '%';
            document.getElementById('difficultyMediumValue').textContent = medium + '%';
            document.getElementById('difficultyLowValue').textContent = low + '%';
            
            const total = high + medium + low;
            document.getElementById('totalDifficultyRatio').textContent = total;
            document.getElementById('totalDifficultyRatio').style.color = total === 100 ? '#28a745' : '#dc3545';
        }

        // Ïà´Ïûê ÏûÖÎ†•ÏóêÏÑú ÎÇúÏù¥ÎèÑ Ïä¨ÎùºÏù¥ÎçîÎ°ú ÎèôÍ∏∞Ìôî
        function syncDifficultyRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateDifficultyRatio();
            }
        }


        // Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
        function collectFormData() {
            // ÏÑ†ÌÉùÎêú Ï£ºÏöî ÏòÅÏó≠Îì§ ÏàòÏßë
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });

            const data = {
                school_level: document.getElementById('schoolLevel').value,
                grade: parseInt(document.getElementById('grade').value),
                total_questions: parseInt(document.getElementById('totalQuestions').value),
                subjects: selectedSubjects, // Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•
                subject_details: [],
                subject_ratios: [],
                question_format: document.getElementById('questionFormat').value,
                format_counts: [],
                difficulty_distribution: []
            };

            // ÏÑ∏Î∂Ä ÏòÅÏó≠ ÏàòÏßë
            const subjectDetails = {};
            
            // ÎèÖÌï¥ Ïú†Ìòï ÏàòÏßë (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            const selectedReadingTypes = [];
            document.querySelectorAll('input[name="reading_types"]:checked').forEach(cb => {
                selectedReadingTypes.push(cb.value); // IDÍ∞Ä ÏïÑÎãå ÌÖçÏä§Ìä∏ Í∞í
            });
            if (selectedReadingTypes.length > 0) {
                subjectDetails.reading_types = selectedReadingTypes;
            }

            // Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨ Î∞è ÌÜ†ÌîΩ ÏàòÏßë (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            const selectedGrammarCategories = [];
            const selectedGrammarTopics = [];
            document.querySelectorAll('input[name="grammar_categories"]:checked').forEach(cb => {
                selectedGrammarCategories.push(cb.value); // IDÍ∞Ä ÏïÑÎãå ÌÖçÏä§Ìä∏ Í∞í
            });
            document.querySelectorAll('input[name^="grammar_topics_"]:checked').forEach(cb => {
                selectedGrammarTopics.push(cb.value); // IDÍ∞Ä ÏïÑÎãå ÌÖçÏä§Ìä∏ Í∞í
            });
            if (selectedGrammarCategories.length > 0) {
                subjectDetails.grammar_categories = selectedGrammarCategories;
            }
            if (selectedGrammarTopics.length > 0) {
                subjectDetails.grammar_topics = selectedGrammarTopics;
            }

            // Ïñ¥Ìúò Ïπ¥ÌÖåÍ≥†Î¶¨ ÏàòÏßë (ÌÖçÏä§Ìä∏ Í∞íÏúºÎ°ú)
            const selectedVocabCategories = [];
            document.querySelectorAll('input[name="vocabulary_categories"]:checked').forEach(cb => {
                selectedVocabCategories.push(cb.value); // IDÍ∞Ä ÏïÑÎãå ÌÖçÏä§Ìä∏ Í∞í
            });
            if (selectedVocabCategories.length > 0) {
                subjectDetails.vocabulary_categories = selectedVocabCategories;
            }

            data.subject_details = subjectDetails;

            // ÏòÅÏó≠Î≥Ñ ÎπÑÏú® ÏàòÏßë
            selectedSubjects.forEach(subject => {
                const ratioElement = document.getElementById(`ratio${subject}`);
                if (ratioElement) {
                    data.subject_ratios.push({
                        subject: subject,
                        ratio: parseInt(ratioElement.value)
                    });
                }
            });

            // ÌòïÏãùÎ≥Ñ Î¨∏Ï†ú ÎπÑÏú® ÏàòÏßë
            const format = data.question_format;
            if (format === 'Ï†ÑÏ≤¥') {
                const multipleElement = document.getElementById('ratioMultiple');
                const shortElement = document.getElementById('ratioShort');
                const essayElement = document.getElementById('ratioEssay');
                
                data.format_ratios = [
                    { format: 'Í∞ùÍ¥ÄÏãù', ratio: multipleElement ? parseInt(multipleElement.value) : 0 },
                    { format: 'Ï£ºÍ¥ÄÏãù', ratio: shortElement ? parseInt(shortElement.value) : 0 },
                    { format: 'ÏÑúÏà†Ìòï', ratio: essayElement ? parseInt(essayElement.value) : 0 }
                ];
            } else {
                data.format_ratios = [
                    { format: format, ratio: 100 }
                ];
            }

            // ÎÇúÏù¥ÎèÑ Î∂ÑÎ∞∞ ÏàòÏßë
            data.difficulty_distribution = [
                { difficulty: 'ÏÉÅ', ratio: parseInt(document.getElementById('difficultyHigh').value) },
                { difficulty: 'Ï§ë', ratio: parseInt(document.getElementById('difficultyMedium').value) },
                { difficulty: 'Ìïò', ratio: parseInt(document.getElementById('difficultyLow').value) }
            ];

            // Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠ ÏàòÏßë
            const additionalRequirements = document.getElementById('additionalRequirements').value.trim();
            if (additionalRequirements) {
                data.additional_requirements = additionalRequirements;
            }

            return data;
        }

        // Î¨∏Ï†úÏßÄ ÏÉùÏÑ± Ìï®Ïàò
        async function generateExam() {
            console.log('üö® generateExam Ìï®Ïàò ÏãúÏûë!');
            
            // Î°úÎî© ÌëúÏãú
            document.getElementById('loading').style.display = 'block';
            document.getElementById('examResult').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                // Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                console.log('üîç collectFormData Ìò∏Ï∂ú ÏãúÏûë...');
                const formData = collectFormData();
                console.log('‚úÖ collectFormData ÏôÑÎ£å!');
                console.log('Î¨∏Ï†úÏßÄ ÏÉùÏÑ± ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞:', formData);

                // API Ìò∏Ï∂ú
                const response = await fetch('/question-options', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Î•º ÏΩòÏÜîÏóê Ï∂úÎ†• (Í∞úÎ∞úÏûê ÎèÑÍµ¨ÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•)
                console.log('='.repeat(80));
                console.log('üéâ ÏòµÏÖò ÏûÖÎ†• ÏôÑÎ£å! ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:');
                console.log('='.repeat(80));
                console.log('üìä Ï†ÑÏ≤¥ ÏùëÎãµ:', result);
                console.log('üìù ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞:', result.request_data);
                console.log('='.repeat(80));
                
                if (response.ok && result.status === 'success') {
                    displayInputResult(result);
                    document.getElementById('examResult').style.display = 'block';
                } else {
                    throw new Error(result.message || 'ÏÑúÎ≤Ñ Ïò§Î•ò');
                }

            } catch (error) {
                console.error('='.repeat(80));
                console.error('‚ùå Î¨∏Ï†úÏßÄ ÏÉùÏÑ± Ïò§Î•ò Î∞úÏÉù:');
                console.error('='.repeat(80));
                console.error('Ïò§Î•ò Î©îÏãúÏßÄ:', error.message);
                console.error('Ï†ÑÏ≤¥ Ïò§Î•ò Í∞ùÏ≤¥:', error);
                if (typeof result !== 'undefined') {
                    console.error('ÏÑúÎ≤Ñ ÏùëÎãµ:', result);
                }
                console.error('='.repeat(80));
                
                document.getElementById('errorData').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨ Ìï®Ïàò
        function copyPrompt() {
            const promptContent = document.getElementById('promptContent');
            if (promptContent) {
                const textArea = document.createElement('textarea');
                textArea.value = promptContent.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Î≥µÏÇ¨ ÏôÑÎ£å ÏïåÎ¶º
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Î≥µÏÇ¨Îê®!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#007bff';
                }, 2000);
            }
        }

        // Ï†úÎØ∏ÎÇòÏù¥ ÏùëÎãµ Î≥µÏÇ¨ Ìï®Ïàò
        function copyResponse() {
            const responseContent = document.getElementById('responseContent');
            if (responseContent) {
                const textArea = document.createElement('textarea');
                textArea.value = responseContent.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Î≥µÏÇ¨ ÏôÑÎ£å ÏïåÎ¶º
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Î≥µÏÇ¨Îê®!';
                button.style.background = '#198754';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#28a745';
                }, 2000);
            }
        }

        // ÏûÖÎ†• Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
        function displayInputResult(result) {
            const examContent = document.getElementById('examContent');
            const requestData = result.request_data;
            const distributionSummary = result.distribution_summary;
            const prompt = result.prompt;
            const llmResponse = result.llm_response;
            const llmError = result.llm_error;
            const subjectTypesValidation = result.subject_types_validation;
            
            let html = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="color: #28a745; margin-bottom: 15px;">‚úÖ ${result.message}</h2>`;
            
            // Î∂ÑÎ∞∞ Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
            if (distributionSummary) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üìä Î¨∏Ï†ú Î∂ÑÎ∞∞ Í≤∞Í≥º</h4>
                        <p><strong>Ï¥ù Î¨∏Ï†ú Ïàò:</strong> ${distributionSummary.total_questions}Î¨∏Ï†ú</p>
                        <p><strong>Í≤ÄÏ¶ù ÌÜµÍ≥º:</strong> ${distributionSummary.validation_passed ? '‚úÖ ÌÜµÍ≥º' : '‚ùå Ïã§Ìå®'}</p>
                        
                        <h5 style="margin-top: 15px;">ÏòÅÏó≠Î≥Ñ Î∂ÑÎ∞∞:</h5>
                        ${distributionSummary.subject_distribution.map(item => 
                            `<p>‚Ä¢ <strong>${item.subject}:</strong> ${item.count}Î¨∏Ï†ú (${item.ratio}%)</p>`
                        ).join('')}
                        
                        <h5 style="margin-top: 15px;">ÌòïÏãùÎ≥Ñ Î∂ÑÎ∞∞:</h5>
                        ${distributionSummary.format_distribution.map(item => 
                            `<p>‚Ä¢ <strong>${item.format}:</strong> ${item.count}Î¨∏Ï†ú (${item.ratio}%)</p>`
                        ).join('')}
                        
                        <h5 style="margin-top: 15px;">ÎÇúÏù¥ÎèÑÎ≥Ñ Î∂ÑÎ∞∞:</h5>
                        ${distributionSummary.difficulty_distribution.map(item => 
                            `<p>‚Ä¢ <strong>${item.difficulty}:</strong> ${item.count}Î¨∏Ï†ú (${item.ratio}%)</p>`
                        ).join('')}
                    </div>`;
            }
            
            // ÏòÅÏó≠Î≥Ñ Ï∂úÏ†ú Ïú†Ìòï Í≤ÄÏ¶ù Í≤∞Í≥º
            if (subjectTypesValidation) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üéØ ÏòÅÏó≠Î≥Ñ Ï∂úÏ†ú Ïú†Ìòï ÌôïÏù∏</h4>
                        ${subjectTypesValidation.reading_types.length > 0 ? 
                            `<p><strong>üìñ ÎèÖÌï¥ Ïú†Ìòï:</strong> ${subjectTypesValidation.reading_types.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.grammar_categories.length > 0 ? 
                            `<p><strong>üìù Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${subjectTypesValidation.grammar_categories.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.grammar_topics.length > 0 ? 
                            `<p><strong>üìù Î¨∏Î≤ï ÌÜ†ÌîΩ:</strong> ${subjectTypesValidation.grammar_topics.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.vocabulary_categories.length > 0 ? 
                            `<p><strong>üìö Ïñ¥Ìúò Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${subjectTypesValidation.vocabulary_categories.join(', ')}</p>` : ''}
                    </div>`;
            }
            
            // Ï†úÎØ∏ÎÇòÏù¥ ÏùëÎãµ Í≤∞Í≥º ÌëúÏãú
            if (llmResponse) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #28a745;">
                        <h3 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center;">
                            ü§ñ Ï†úÎØ∏ÎÇòÏù¥ AI ÏùëÎãµ Í≤∞Í≥º
                            <button onclick="copyResponse()" style="margin-left: auto; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üìã Î≥µÏÇ¨</button>
                        </h3>
                        <div id="responseContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.4; max-height: 800px; overflow-y: auto; border: 1px solid #dee2e6;">${llmResponse}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            üéØ Ï†úÎØ∏ÎÇòÏù¥ AIÍ∞Ä ÏÉùÏÑ±Ìïú Î¨∏Ï†úÏßÄÏûÖÎãàÎã§!
                        </div>
                    </div>`;
            }
            
            // LLM Ïò§Î•ò ÌëúÏãú
            if (llmError) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #dc3545;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">‚ùå AI ÏùëÎãµ Ïò§Î•ò</h3>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">${llmError}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            üí° API ÌÇ§Î•º ÌôïÏù∏ÌïòÍ±∞ÎÇò ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.
                        </div>
                    </div>`;
            }
            
            // ÏÉùÏÑ±Îêú ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú
            if (prompt) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #007bff;">
                        <h3 style="color: #007bff; margin-bottom: 15px; display: flex; align-items: center;">
                            üöÄ ÏÉùÏÑ±Îêú ÌîÑÎ°¨ÌîÑÌä∏
                            <button onclick="copyPrompt()" style="margin-left: auto; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üìã Î≥µÏÇ¨</button>
                        </h3>
                        <div id="promptContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.4; max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">${prompt}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            üí° Ïù¥ ÌîÑÎ°¨ÌîÑÌä∏Î•º Î≥µÏÇ¨Ìï¥ÏÑú ChatGPT, Claude, ÎòêÎäî Îã§Î•∏ AI Î™®Îç∏Ïóê Î∂ôÏó¨ÎÑ£Ïñ¥ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî!
                        </div>
                    </div>`;
            }
            
            html += `
                    <h3 style="color: #333; margin-top: 20px; margin-bottom: 10px;">üìã ÏûÖÎ†•Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞:</h3>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üè´ Í∏∞Î≥∏ Ï†ïÎ≥¥</h4>
                        <p><strong>ÌïôÍµêÍ∏â:</strong> ${requestData.school_level}</p>
                        <p><strong>ÌïôÎÖÑ:</strong> ${requestData.grade}ÌïôÎÖÑ</p>
                        <p><strong>Ï¥ù Î¨∏Ï†ú Ïàò:</strong> ${requestData.total_questions}Í∞ú</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üéØ ÏÑ†ÌÉùÎêú ÏòÅÏó≠</h4>
                        <p><strong>ÏòÅÏó≠:</strong> ${requestData.subjects.join(', ')}</p>
                        
                        ${requestData.subject_details.reading_types.length > 0 ? 
                            `<p><strong>üìñ ÎèÖÌï¥ Ïú†Ìòï:</strong> ${requestData.subject_details.reading_types.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.grammar_categories.length > 0 ? 
                            `<p><strong>üìù Î¨∏Î≤ï Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${requestData.subject_details.grammar_categories.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.grammar_topics.length > 0 ? 
                            `<p><strong>üìù Î¨∏Î≤ï ÌÜ†ÌîΩ:</strong> ${requestData.subject_details.grammar_topics.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.vocabulary_categories.length > 0 ? 
                            `<p><strong>üìö Ïñ¥Ìúò Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${requestData.subject_details.vocabulary_categories.join(', ')}</p>` : ''}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">‚öñÔ∏è ÏòÅÏó≠Î≥Ñ ÎπÑÏú®</h4>
                        ${requestData.subject_ratios.map(ratio => 
                            `<p><strong>${ratio.subject}:</strong> ${ratio.ratio}%</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üìã Î¨∏Ï†ú ÌòïÏãù</h4>
                        <p><strong>ÏÑ†ÌÉùÎêú ÌòïÏãù:</strong> ${requestData.question_format}</p>
                        ${requestData.format_ratios.map(format => 
                            `<p><strong>${format.format}:</strong> ${format.ratio}%</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">üéØ ÎÇúÏù¥ÎèÑ Î∂ÑÎ∞∞</h4>
                        ${requestData.difficulty_distribution.map(diff => 
                            `<p><strong>${diff.difficulty}:</strong> ${diff.ratio}%</p>`
                        ).join('')}
                    </div>`;
            
            // Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠ ÌëúÏãú
            if (requestData.additional_requirements) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px;">
                        <h4 style="color: #007bff;">üìù Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠</h4>
                        <p style="background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 4px solid #007bff; white-space: pre-wrap;">${requestData.additional_requirements}</p>
                    </div>`;
            }
            
            html += `</div>
            `;
            
            examContent.innerHTML = html;
        }

        // Í∏∞Ï°¥ Î¨∏Ï†úÏßÄ Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò (ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå)
        function displayExamResult(examData) {
            const examContent = document.getElementById('examContent');
            
            let html = `
                <div class="exam-section">
                    <div class="exam-title">üìã ÏãúÌóò Ï†ïÎ≥¥</div>
                    <p><strong>ÌïôÍµêÍ∏â:</strong> ${examData.exam_info.school_level}</p>
                    <p><strong>ÌïôÎÖÑ:</strong> ${examData.exam_info.grade}ÌïôÎÖÑ</p>
                    <p><strong>Ï¥ù Î¨∏Ï†ú Ïàò:</strong> ${examData.exam_info.total_questions}Í∞ú</p>
                    <p><strong>ÏòÅÏó≠:</strong> ${examData.exam_info.subjects.join(', ')}</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('question-paper')">üìù Î¨∏Ï†úÏßÄ</button>
                    <button class="tab" onclick="showTab('answer-sheet')">‚úÖ ÎãµÏïàÏßÄ</button>
                </div>

                <div id="question-paper" class="tab-content active">
            `;

            // ÏßÄÎ¨∏Îì§ÏùÄ Í∞Å Î¨∏Ï†úÏôÄ Ìï®Íªò ÌëúÏãúÎêòÎØÄÎ°ú Î≥ÑÎèÑ ÌëúÏãú Î∂àÌïÑÏöî

            // Î¨∏Ï†úÎì§ ÌëúÏãú (ÏßÄÎ¨∏/ÏòàÎ¨∏Í≥º Ìï®Íªò)
            if (examData.questions && examData.questions.length > 0) {
                html += '<div class="exam-section"><div class="exam-title">‚ùì Î¨∏Ï†ú</div>';
                examData.questions.forEach(question => {
                    html += `<div class="question">`;
                    
                    // Í¥ÄÎ†® ÏßÄÎ¨∏ Ï∞æÍ∏∞ Î∞è ÌëúÏãú
                    if (question.passage_id && examData.passages) {
                        const relatedPassage = examData.passages.find(p => p.id === question.passage_id);
                        if (relatedPassage) {
                            html += `
                                <div class="passage-for-question">
                                    <div class="passage-title">üìñ ÏßÄÎ¨∏: ${relatedPassage.title}</div>
                                    <div class="passage-content">${relatedPassage.content}</div>
                                    <small>Îã®Ïñ¥ Ïàò: ${relatedPassage.word_count}Í∞ú</small>
                                </div>
                            `;
                        }
                    }
                    
                    // Í¥ÄÎ†® ÏòàÎ¨∏ Ï∞æÍ∏∞ Î∞è ÌëúÏãú  
                    if (question.example_id && examData.examples) {
                        const relatedExample = examData.examples.find(e => e.target_problem === `problem_${question.question_number}`);
                        if (relatedExample) {
                            html += `
                                <div class="example-for-question">
                                    <div class="example-title">üìù ÏòàÎ¨∏:</div>
                                    <div class="example-content">${relatedExample.content}</div>
                                </div>
                            `;
                        }
                    }
                    
                    // Ï∞∏Ï°∞ Î¨∏Ï†úÏùò ÏßÄÎ¨∏ ÌëúÏãú (Í∞ôÏùÄ ÏßÄÎ¨∏ÏùÑ ÏÇ¨Ïö©ÌïòÎäî Ïó∞ÏÜç Î¨∏Ï†ú)
                    if (question.reference_problem_id && !question.passage_id && !question.example_id) {
                        html += `
                            <div class="reference-note">
                                <small>‚Äª ÏúÑ ÏßÄÎ¨∏ÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú Î¨∏Ï†úÏûÖÎãàÎã§.</small>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="question-number">${question.question_number}Î≤à</div>
                        <p><strong>${question.question_text}</strong></p>
                    `;
                    
                    if (question.choices && question.choices.length > 0) {
                        html += '<div class="choices">';
                        question.choices.forEach(choice => {
                            html += `<p>${choice}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                        <small>ÏòÅÏó≠: ${question.subject} | ÎÇúÏù¥ÎèÑ: ${question.difficulty} | ÌòïÏãù: ${question.question_type}</small>
                    </div>`;
                });
                html += '</div>';
            }

            html += '</div>'; // question-paper ÎÅù

            // ÎãµÏïàÏßÄ ÌÉ≠
            html += '<div id="answer-sheet" class="tab-content">';
            
            if (examData.answer_sheet && examData.answer_sheet.answers) {
                html += '<div class="exam-section"><div class="exam-title">‚úÖ Ï†ïÎãµ Î∞è Ìï¥ÏÑ§</div>';
                examData.answer_sheet.answers.forEach(answer => {
                    html += `
                        <div class="answer">
                            <div class="question-number">${answer.question_number}Î≤à</div>
                            <p><strong>Ï†ïÎãµ:</strong> ${answer.correct_answer}</p>
                            <div class="explanation">
                                <strong>Ìï¥ÏÑ§:</strong> ${answer.explanation}
                            </div>
                            ${answer.key_points ? `
                                <div style="margin-top: 10px;">
                                    <strong>ÌïµÏã¨ Ìè¨Ïù∏Ìä∏:</strong>
                                    <ul>
                                        ${answer.key_points.map(point => `<li>${point}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                // Ï±ÑÏ†ê Í∏∞Ï§Ä
                if (examData.answer_sheet.grading_criteria) {
                    html += `
                        <div class="exam-section">
                            <div class="exam-title">üìä Ï±ÑÏ†ê Í∏∞Ï§Ä</div>
                            ${Object.entries(examData.answer_sheet.grading_criteria).map(([format, criteria]) => 
                                `<p><strong>${format}:</strong> ${criteria}</p>`
                            ).join('')}
                        </div>
                    `;
                }
            }

            html += '</div>'; // answer-sheet ÎÅù

            examContent.innerHTML = html;
        }

        // ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            
            document.querySelectorAll('input[name="subjects"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSubjectDetails();
                    updateSubjectRatios();
                });
            });
            
            document.getElementById('questionFormat').addEventListener('change', updateFormatCounts);
            document.getElementById('totalQuestions').addEventListener('input', updateFormatCounts);
            
            document.getElementById('questionForm').addEventListener('submit', generateExam);
            
            // Ï¥àÍ∏∞ ÏÑ§Ï†ï
            updateSubjectRatios();
            updateFormatCounts();
        });
    </script>
</body>
</html>
