<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì œ ìƒì„± ì˜µì…˜ ì„¤ì •</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ratio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .ratio-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .range-value {
            font-weight: bold;
            color: #007bff;
            margin-left: 10px;
        }
        
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .submit-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            display: none;
        }
        
        .exam-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .exam-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .passage {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .question {
            background: #fff;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .question-number {
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .choices {
            margin-left: 20px;
        }
        
        .answer {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #28a745;
        }
        
        .explanation {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #007bff;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .error-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8d7da;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            display: none;
        }
        
        .passage-for-question, .example-for-question {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .passage-title, .example-title {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .passage-content, .example-content {
            line-height: 1.6;
            color: #333;
            margin-bottom: 10px;
        }
        
        .reference-note {
            background: #fffbf0;
            border: 1px solid #ffd700;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š ë¬¸ì œ ìƒì„± ì˜µì…˜ ì„¤ì •</h1>
        
        <form id="questionForm">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="form-section">
                <div class="section-title">ğŸ“– ê¸°ë³¸ ì •ë³´</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="schoolLevel">í•™êµê¸‰</label>
                        <select id="schoolLevel" name="school_level" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì¤‘í•™êµ">ì¤‘í•™êµ</option>
                            <option value="ê³ ë“±í•™êµ">ê³ ë“±í•™êµ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade">í•™ë…„</label>
                        <select id="grade" name="grade" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="totalQuestions">ì´ ë¬¸ì œ ìˆ˜</label>
                        <input type="number" id="totalQuestions" name="total_questions" min="1" max="100" value="20" required>
                    </div>
                </div>
            </div>

            <!-- ì˜ì—­ ì„ íƒ -->
            <div class="form-section">
                <div class="section-title">ğŸ“ ì˜ì—­ ì„ íƒ</div>
                <div class="form-group">
                    <label>ì£¼ìš” ì˜ì—­ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_reading" value="ë…í•´" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_reading">ë…í•´</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_grammar" value="ë¬¸ë²•" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_grammar">ë¬¸ë²•</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subject_vocabulary" value="ì–´íœ˜" name="subjects" onchange="updateSubjectDetails()">
                            <label for="subject_vocabulary">ì–´íœ˜</label>
                        </div>
                    </div>
                </div>
                
                <div id="subjectDetails" style="margin-top: 20px;">
                    <!-- ì„¸ë¶€ ì˜ì—­ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>

            <!-- ë¬¸ì œ ë¹„ìœ¨ -->
            <div class="form-section">
                <div class="section-title">âš–ï¸ ì˜ì—­ë³„ ë¬¸ì œ ë¹„ìœ¨</div>
                <div id="subjectRatios" class="ratio-group">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    ì´ ë¹„ìœ¨: <span id="totalRatio">0</span>% (100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)
                </div>
            </div>

            <!-- ë¬¸ì œ í˜•ì‹ -->
            <div class="form-section">
                <div class="section-title">ğŸ“‹ ë¬¸ì œ í˜•ì‹</div>
                <div class="form-group">
                    <label for="questionFormat">ë¬¸ì œ í˜•ì‹</label>
                    <select id="questionFormat" name="question_format" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì „ì²´">ì „ì²´</option>
                        <option value="ê°ê´€ì‹">ê°ê´€ì‹</option>
                        <option value="ì£¼ê´€ì‹">ì£¼ê´€ì‹</option>
                        <option value="ì„œìˆ í˜•">ì„œìˆ í˜•</option>
                    </select>
                </div>
                
                <div id="formatCounts" style="margin-top: 20px;">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>

            <!-- ë‚œì´ë„ ë¶„ë°° -->
            <div class="form-section">
                <div class="section-title">ğŸ¯ ë‚œì´ë„ ë¶„ë°°</div>
                <div class="ratio-group">
                    <div class="ratio-item">
                        <label for="difficultyHigh">ìƒ (ì–´ë ¤ì›€)</label>
                        <input type="range" id="difficultyHigh" min="0" max="100" value="30" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyHighNum" min="0" max="100" value="30" oninput="syncDifficultyRatio('difficultyHigh')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyHighValue">30%</span>
                    </div>
                    <div class="ratio-item">
                        <label for="difficultyMedium">ì¤‘ (ë³´í†µ)</label>
                        <input type="range" id="difficultyMedium" min="0" max="100" value="50" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyMediumNum" min="0" max="100" value="50" oninput="syncDifficultyRatio('difficultyMedium')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyMediumValue">50%</span>
                    </div>
                    <div class="ratio-item">
                        <label for="difficultyLow">í•˜ (ì‰¬ì›€)</label>
                        <input type="range" id="difficultyLow" min="0" max="100" value="20" oninput="updateDifficultyRatio()">
                        <input type="number" id="difficultyLowNum" min="0" max="100" value="20" oninput="syncDifficultyRatio('difficultyLow')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="difficultyLowValue">20%</span>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    ì´ ë‚œì´ë„ ë¹„ìœ¨: <span id="totalDifficultyRatio">100</span>% (100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)
                </div>
            </div>

            <!-- ì¶”ê°€ ìš”êµ¬ì‚¬í•­ -->
            <div class="form-section">
                <h3>ğŸ“ ì¶”ê°€ ìš”êµ¬ì‚¬í•­ (ì„ íƒì‚¬í•­)</h3>
                <div class="input-group">
                    <label for="additionalRequirements">íŠ¹ë³„í•œ ìš”êµ¬ì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”:</label>
                    <textarea 
                        id="additionalRequirements" 
                        name="additionalRequirements"
                        placeholder="ì˜ˆ: íŠ¹ì • ì£¼ì œë‚˜ ìƒí™©ì„ í¬í•¨í•´ì£¼ì„¸ìš”, ë¬¸ì œ ìŠ¤íƒ€ì¼ ìš”ì²­, íŠ¹ë³„í•œ í˜•ì‹ ë“±..."
                        style="width: 100%; height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                    ></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        ğŸ’¡ ì˜ˆì‹œ: "í•™êµìƒí™œê³¼ ê´€ë ¨ëœ ìƒí™©ì„ í¬í•¨í•´ì£¼ì„¸ìš”", "ëŒ€í™”ë¬¸ ìœ„ì£¼ë¡œ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”", "ì‹¤ìƒí™œ ì˜ˆì‹œë¥¼ ë§ì´ ì‚¬ìš©í•´ì£¼ì„¸ìš”" ë“±
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button type="button" class="submit-btn" onclick="generateExam()" style="background: linear-gradient(45deg, #28a745, #20c997);">ğŸš€ ë¬¸ì œì§€ ìƒì„±</button>
            </div>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="result-section" id="result">
            <h3>âœ… ì œì¶œ ì„±ê³µ!</h3>
            <pre id="resultData"></pre>
        </div>

        <div class="error-section" id="error">
            <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
            <pre id="errorData"></pre>
        </div>

        <div class="result-section" id="examResult" style="display: none;">
            <h3>ğŸ‰ ë¬¸ì œì§€ ìƒì„± ì™„ë£Œ!</h3>
            <div id="examContent">
                <!-- ìƒì„±ëœ ë¬¸ì œì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        let categories = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´í…Œê³ ë¦¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadCategories() {
            try {
                const response = await fetch('/categories');
                categories = await response.json();
                console.log('ì¹´í…Œê³ ë¦¬ ë¡œë“œë¨:', categories);
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í˜„ì¬ ì„ íƒ ìƒíƒœë¥¼ ì €ì¥í•  ê°ì²´
        let selectedDetails = {
            reading_types: [],
            grammar_categories: [],
            grammar_topics: {},
            vocabulary_categories: []
        };

        // ì˜ì—­ ì„ íƒì— ë”°ë¥¸ ì„¸ë¶€ ì˜ì—­ í‘œì‹œ
        function updateSubjectDetails() {
            // í˜„ì¬ ì„ íƒëœ ì„¸ë¶€ í•­ëª©ë“¤ì„ ì €ì¥
            saveCurrentSelections();
            
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });
            
            const detailsDiv = document.getElementById('subjectDetails');
            
            if (selectedSubjects.length === 0) {
                detailsDiv.innerHTML = '';
                return;
            }

            let html = '<div class="section-title">ì„¸ë¶€ ì˜ì—­ ì„ íƒ</div>';
            
            // ë…í•´ê°€ ì„ íƒëœ ê²½ìš°
            if (selectedSubjects.includes('ë…í•´') && categories.reading_types) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">ğŸ“– ë…í•´ ìœ í˜•</h4>';
                html += '<div class="checkbox-group">';
                categories.reading_types.forEach(type => {
                    const isChecked = selectedDetails.reading_types.includes(type.name) ? 'checked' : '';
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="reading_${type.id}" value="${type.name}" name="reading_types" ${isChecked}>
                            <label for="reading_${type.id}">${type.name}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // ë¬¸ë²•ì´ ì„ íƒëœ ê²½ìš°
            if (selectedSubjects.includes('ë¬¸ë²•') && categories.grammar_categories) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">ğŸ“ ë¬¸ë²• ì¹´í…Œê³ ë¦¬</h4>';
                categories.grammar_categories.forEach(cat => {
                    const isCatChecked = selectedDetails.grammar_categories.includes(cat.name) ? 'checked' : '';
                    const topicsVisible = selectedDetails.grammar_categories.includes(cat.name) ? 'block' : 'none';
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                            <div class="checkbox-item" style="margin-bottom: 10px;">
                                <input type="checkbox" id="grammar_cat_${cat.id}" value="${cat.name}" name="grammar_categories" onchange="toggleGrammarTopics(${cat.id})" ${isCatChecked}>
                                <label for="grammar_cat_${cat.id}" style="font-weight: bold;">${cat.name}</label>
                            </div>
                            <div id="grammar_topics_${cat.id}" style="margin-left: 20px; display: ${topicsVisible};">
                                <div class="checkbox-group">
                    `;
                    if (cat.topics && cat.topics.length > 0) {
                        cat.topics.forEach(topic => {
                            const isTopicChecked = selectedDetails.grammar_topics.includes(topic.name) ? 'checked' : '';
                            html += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="topic_${topic.id}" value="${topic.name}" name="grammar_topics_${cat.id}" ${isTopicChecked}>
                                    <label for="topic_${topic.id}">${topic.name}</label>
                                </div>
                            `;
                        });
                    }
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // ì–´íœ˜ê°€ ì„ íƒëœ ê²½ìš°
            if (selectedSubjects.includes('ì–´íœ˜') && categories.vocabulary_categories) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #007bff; margin-bottom: 10px;">ğŸ“š ì–´íœ˜ ì¹´í…Œê³ ë¦¬</h4>';
                html += '<div class="checkbox-group">';
                categories.vocabulary_categories.forEach(cat => {
                    const isChecked = selectedDetails.vocabulary_categories.includes(cat.name) ? 'checked' : '';
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="vocab_${cat.id}" value="${cat.name}" name="vocabulary_categories" ${isChecked}>
                            <label for="vocab_${cat.id}">${cat.name}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            detailsDiv.innerHTML = html;
        }

        // í˜„ì¬ ì„ íƒëœ ì„¸ë¶€ í•­ëª©ë“¤ì„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        function saveCurrentSelections() {
            // ë…í•´ ìœ í˜• ì €ì¥ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            selectedDetails.reading_types = [];
            document.querySelectorAll('input[name="reading_types"]:checked').forEach(cb => {
                selectedDetails.reading_types.push(cb.value);
            });
            
            // ë¬¸ë²• ì¹´í…Œê³ ë¦¬ ì €ì¥ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            selectedDetails.grammar_categories = [];
            document.querySelectorAll('input[name="grammar_categories"]:checked').forEach(cb => {
                selectedDetails.grammar_categories.push(cb.value);
            });
            
            // ë¬¸ë²• í† í”½ ì €ì¥ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            selectedDetails.grammar_topics = [];
            document.querySelectorAll('input[name^="grammar_topics_"]:checked').forEach(cb => {
                selectedDetails.grammar_topics.push(cb.value);
            });
            
            // ì–´íœ˜ ì¹´í…Œê³ ë¦¬ ì €ì¥ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            selectedDetails.vocabulary_categories = [];
            document.querySelectorAll('input[name="vocabulary_categories"]:checked').forEach(cb => {
                selectedDetails.vocabulary_categories.push(cb.value);
            });
        }

        // ë¬¸ë²• ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ í† í”½ í‘œì‹œ/ìˆ¨ê¹€
        function toggleGrammarTopics(categoryId) {
            const checkbox = document.getElementById(`grammar_cat_${categoryId}`);
            const topicsDiv = document.getElementById(`grammar_topics_${categoryId}`);
            
            if (checkbox.checked) {
                topicsDiv.style.display = 'block';
            } else {
                topicsDiv.style.display = 'none';
                // ì¹´í…Œê³ ë¦¬ í•´ì œ ì‹œ í•´ë‹¹ í† í”½ë“¤ë„ ëª¨ë‘ í•´ì œ
                const topicCheckboxes = topicsDiv.querySelectorAll('input[type="checkbox"]');
                topicCheckboxes.forEach(cb => cb.checked = false);
            }
        }

        // ì˜ì—­ë³„ ë¹„ìœ¨ ì—…ë°ì´íŠ¸
        function updateSubjectRatios() {
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });
            
            const ratiosDiv = document.getElementById('subjectRatios');
            
            if (selectedSubjects.length === 0) {
                ratiosDiv.innerHTML = '';
                return;
            }

            let html = '';
            const defaultRatio = Math.floor(100 / selectedSubjects.length);
            const remainder = 100 % selectedSubjects.length;
            
            selectedSubjects.forEach((subject, index) => {
                const ratio = index === 0 ? defaultRatio + remainder : defaultRatio;
                html += `
                    <div class="ratio-item">
                        <label for="ratio${subject}">${subject} ë¹„ìœ¨</label>
                        <input type="range" id="ratio${subject}" min="0" max="100" value="${ratio}" oninput="updateTotalRatio()">
                        <input type="number" id="ratio${subject}Num" min="0" max="100" value="${ratio}" oninput="syncSubjectRatio('ratio${subject}')" style="width: 60px; margin-left: 10px;">
                        <span class="range-value" id="ratio${subject}Value">${ratio}%</span>
                    </div>
                `;
            });
            
            ratiosDiv.innerHTML = html;
            updateTotalRatio();
        }

        // ì´ ë¹„ìœ¨ ê³„ì‚°
        function updateTotalRatio() {
            const ranges = document.querySelectorAll('#subjectRatios input[type="range"]');
            let total = 0;
            
            ranges.forEach(range => {
                const value = parseInt(range.value);
                total += value;
                
                // ìŠ¬ë¼ì´ë” ê°’ì„ ìˆ«ì ì…ë ¥ë€ì— ë™ê¸°í™”
                const numberInput = document.getElementById(range.id + 'Num');
                if (numberInput) {
                    numberInput.value = value;
                }
                
                // í¼ì„¼íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                const valueSpan = document.getElementById(range.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = value + '%';
                }
            });
            
            document.getElementById('totalRatio').textContent = total;
            document.getElementById('totalRatio').style.color = total === 100 ? '#28a745' : '#dc3545';
        }

        // ìˆ«ì ì…ë ¥ì—ì„œ ì˜ì—­ë³„ ìŠ¬ë¼ì´ë”ë¡œ ë™ê¸°í™”
        function syncSubjectRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateTotalRatio();
            }
        }

        // ë¬¸ì œ í˜•ì‹ë³„ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateFormatCounts() {
            const format = document.getElementById('questionFormat').value;
            const countsDiv = document.getElementById('formatCounts');
            const totalQuestions = parseInt(document.getElementById('totalQuestions').value) || 20;
            
            if (!format || format === 'ì „ì²´') {
                countsDiv.innerHTML = `
                    <div class="section-title">í˜•ì‹ë³„ ë¬¸ì œ ë¹„ìœ¨</div>
                    <div class="ratio-group">
                        <div class="ratio-item">
                            <label for="ratioMultiple">ê°ê´€ì‹</label>
                            <input type="range" id="ratioMultiple" min="0" max="100" value="60" oninput="updateFormatRatio()">
                            <input type="number" id="ratioMultipleNum" min="0" max="100" value="60" oninput="syncFormatRatio('ratioMultiple')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioMultipleValue">60%</span>
                        </div>
                        <div class="ratio-item">
                            <label for="ratioShort">ì£¼ê´€ì‹</label>
                            <input type="range" id="ratioShort" min="0" max="100" value="30" oninput="updateFormatRatio()">
                            <input type="number" id="ratioShortNum" min="0" max="100" value="30" oninput="syncFormatRatio('ratioShort')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioShortValue">30%</span>
                        </div>
                        <div class="ratio-item">
                            <label for="ratioEssay">ì„œìˆ í˜•</label>
                            <input type="range" id="ratioEssay" min="0" max="100" value="10" oninput="updateFormatRatio()">
                            <input type="number" id="ratioEssayNum" min="0" max="100" value="10" oninput="syncFormatRatio('ratioEssay')" style="width: 60px; margin-left: 10px;">
                            <span class="range-value" id="ratioEssayValue">10%</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        ì´ ë¹„ìœ¨: <span id="totalFormatRatio">100</span>% / 100%
                    </div>
                `;
            } else {
                countsDiv.innerHTML = `
                    <div class="section-title">ë¬¸ì œ ìˆ˜</div>
                    <div class="ratio-item">
                        <label for="countSingle">${format} ë¬¸ì œ ìˆ˜</label>
                        <input type="number" id="countSingle" min="0" max="${totalQuestions}" value="${totalQuestions}" readonly>
                    </div>
                `;
            }
            updateFormatRatio();
        }

        // í˜•ì‹ë³„ ë¹„ìœ¨ ì—…ë°ì´íŠ¸
        function updateFormatRatio() {
            const ratioMultiple = parseInt(document.getElementById('ratioMultiple')?.value) || 0;
            const ratioShort = parseInt(document.getElementById('ratioShort')?.value) || 0;
            const ratioEssay = parseInt(document.getElementById('ratioEssay')?.value) || 0;
            
            // ìŠ¬ë¼ì´ë” ê°’ì„ ìˆ«ì ì…ë ¥ë€ì— ë™ê¸°í™”
            const multipleNum = document.getElementById('ratioMultipleNum');
            const shortNum = document.getElementById('ratioShortNum');
            const essayNum = document.getElementById('ratioEssayNum');
            
            if (multipleNum) multipleNum.value = ratioMultiple;
            if (shortNum) shortNum.value = ratioShort;
            if (essayNum) essayNum.value = ratioEssay;
            
            // í¼ì„¼íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            const multipleValue = document.getElementById('ratioMultipleValue');
            const shortValue = document.getElementById('ratioShortValue');
            const essayValue = document.getElementById('ratioEssayValue');
            
            if (multipleValue) multipleValue.textContent = ratioMultiple + '%';
            if (shortValue) shortValue.textContent = ratioShort + '%';
            if (essayValue) essayValue.textContent = ratioEssay + '%';
            
            const total = ratioMultiple + ratioShort + ratioEssay;
            
            const totalSpan = document.getElementById('totalFormatRatio');
            if (totalSpan) {
                totalSpan.textContent = total;
                totalSpan.style.color = total === 100 ? '#28a745' : '#dc3545';
            }
        }

        // ìˆ«ì ì…ë ¥ì—ì„œ ìŠ¬ë¼ì´ë”ë¡œ ë™ê¸°í™”
        function syncFormatRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateFormatRatio();
            }
        }

        // ë‚œì´ë„ ë¹„ìœ¨ ì—…ë°ì´íŠ¸
        function updateDifficultyRatio() {
            const high = parseInt(document.getElementById('difficultyHigh').value);
            const medium = parseInt(document.getElementById('difficultyMedium').value);
            const low = parseInt(document.getElementById('difficultyLow').value);
            
            // ìŠ¬ë¼ì´ë” ê°’ì„ ìˆ«ì ì…ë ¥ë€ì— ë™ê¸°í™”
            const highNum = document.getElementById('difficultyHighNum');
            const mediumNum = document.getElementById('difficultyMediumNum');
            const lowNum = document.getElementById('difficultyLowNum');
            
            if (highNum) highNum.value = high;
            if (mediumNum) mediumNum.value = medium;
            if (lowNum) lowNum.value = low;
            
            // í¼ì„¼íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('difficultyHighValue').textContent = high + '%';
            document.getElementById('difficultyMediumValue').textContent = medium + '%';
            document.getElementById('difficultyLowValue').textContent = low + '%';
            
            const total = high + medium + low;
            document.getElementById('totalDifficultyRatio').textContent = total;
            document.getElementById('totalDifficultyRatio').style.color = total === 100 ? '#28a745' : '#dc3545';
        }

        // ìˆ«ì ì…ë ¥ì—ì„œ ë‚œì´ë„ ìŠ¬ë¼ì´ë”ë¡œ ë™ê¸°í™”
        function syncDifficultyRatio(sliderId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(sliderId + 'Num');
            
            if (slider && numberInput) {
                slider.value = numberInput.value;
                updateDifficultyRatio();
            }
        }


        // í¼ ë°ì´í„° ìˆ˜ì§‘
        function collectFormData() {
            // ì„ íƒëœ ì£¼ìš” ì˜ì—­ë“¤ ìˆ˜ì§‘
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subjects"]:checked').forEach(checkbox => {
                selectedSubjects.push(checkbox.value);
            });

            const data = {
                school_level: document.getElementById('schoolLevel').value,
                grade: parseInt(document.getElementById('grade').value),
                total_questions: parseInt(document.getElementById('totalQuestions').value),
                subjects: selectedSubjects, // ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥
                subject_details: [],
                subject_ratios: [],
                question_format: document.getElementById('questionFormat').value,
                format_counts: [],
                difficulty_distribution: []
            };

            // ì„¸ë¶€ ì˜ì—­ ìˆ˜ì§‘
            const subjectDetails = {};
            
            // ë…í•´ ìœ í˜• ìˆ˜ì§‘ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            const selectedReadingTypes = [];
            document.querySelectorAll('input[name="reading_types"]:checked').forEach(cb => {
                selectedReadingTypes.push(cb.value); // IDê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ ê°’
            });
            if (selectedReadingTypes.length > 0) {
                subjectDetails.reading_types = selectedReadingTypes;
            }

            // ë¬¸ë²• ì¹´í…Œê³ ë¦¬ ë° í† í”½ ìˆ˜ì§‘ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            const selectedGrammarCategories = [];
            const selectedGrammarTopics = [];
            document.querySelectorAll('input[name="grammar_categories"]:checked').forEach(cb => {
                selectedGrammarCategories.push(cb.value); // IDê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ ê°’
            });
            document.querySelectorAll('input[name^="grammar_topics_"]:checked').forEach(cb => {
                selectedGrammarTopics.push(cb.value); // IDê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ ê°’
            });
            if (selectedGrammarCategories.length > 0) {
                subjectDetails.grammar_categories = selectedGrammarCategories;
            }
            if (selectedGrammarTopics.length > 0) {
                subjectDetails.grammar_topics = selectedGrammarTopics;
            }

            // ì–´íœ˜ ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘ (í…ìŠ¤íŠ¸ ê°’ìœ¼ë¡œ)
            const selectedVocabCategories = [];
            document.querySelectorAll('input[name="vocabulary_categories"]:checked').forEach(cb => {
                selectedVocabCategories.push(cb.value); // IDê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ ê°’
            });
            if (selectedVocabCategories.length > 0) {
                subjectDetails.vocabulary_categories = selectedVocabCategories;
            }

            data.subject_details = subjectDetails;

            // ì˜ì—­ë³„ ë¹„ìœ¨ ìˆ˜ì§‘
            selectedSubjects.forEach(subject => {
                const ratioElement = document.getElementById(`ratio${subject}`);
                if (ratioElement) {
                    data.subject_ratios.push({
                        subject: subject,
                        ratio: parseInt(ratioElement.value)
                    });
                }
            });

            // í˜•ì‹ë³„ ë¬¸ì œ ë¹„ìœ¨ ìˆ˜ì§‘
            const format = data.question_format;
            if (format === 'ì „ì²´') {
                const multipleElement = document.getElementById('ratioMultiple');
                const shortElement = document.getElementById('ratioShort');
                const essayElement = document.getElementById('ratioEssay');
                
                data.format_ratios = [
                    { format: 'ê°ê´€ì‹', ratio: multipleElement ? parseInt(multipleElement.value) : 0 },
                    { format: 'ì£¼ê´€ì‹', ratio: shortElement ? parseInt(shortElement.value) : 0 },
                    { format: 'ì„œìˆ í˜•', ratio: essayElement ? parseInt(essayElement.value) : 0 }
                ];
            } else {
                data.format_ratios = [
                    { format: format, ratio: 100 }
                ];
            }

            // ë‚œì´ë„ ë¶„ë°° ìˆ˜ì§‘
            data.difficulty_distribution = [
                { difficulty: 'ìƒ', ratio: parseInt(document.getElementById('difficultyHigh').value) },
                { difficulty: 'ì¤‘', ratio: parseInt(document.getElementById('difficultyMedium').value) },
                { difficulty: 'í•˜', ratio: parseInt(document.getElementById('difficultyLow').value) }
            ];

            // ì¶”ê°€ ìš”êµ¬ì‚¬í•­ ìˆ˜ì§‘
            const additionalRequirements = document.getElementById('additionalRequirements').value.trim();
            if (additionalRequirements) {
                data.additional_requirements = additionalRequirements;
            }

            return data;
        }

        // ë¬¸ì œì§€ ìƒì„± í•¨ìˆ˜
        async function generateExam() {
            console.log('ğŸš¨ generateExam í•¨ìˆ˜ ì‹œì‘!');
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('examResult').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                console.log('ğŸ” collectFormData í˜¸ì¶œ ì‹œì‘...');
                const formData = collectFormData();
                console.log('âœ… collectFormData ì™„ë£Œ!');
                console.log('ë¬¸ì œì§€ ìƒì„± ìš”ì²­ ë°ì´í„°:', formData);

                // API í˜¸ì¶œ
                const response = await fetch('/question-options', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                // ì‘ë‹µ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ê°œë°œì ë„êµ¬ì—ì„œ í™•ì¸ ê°€ëŠ¥)
                console.log('='.repeat(80));
                console.log('ğŸ‰ ì˜µì…˜ ì…ë ¥ ì™„ë£Œ! ì‘ë‹µ ë°ì´í„°:');
                console.log('='.repeat(80));
                console.log('ğŸ“Š ì „ì²´ ì‘ë‹µ:', result);
                console.log('ğŸ“ ì…ë ¥ ë°ì´í„°:', result.request_data);
                console.log('='.repeat(80));
                
                if (response.ok && result.status === 'success') {
                    displayInputResult(result);
                    document.getElementById('examResult').style.display = 'block';
                } else {
                    throw new Error(result.message || 'ì„œë²„ ì˜¤ë¥˜');
                }

            } catch (error) {
                console.error('='.repeat(80));
                console.error('âŒ ë¬¸ì œì§€ ìƒì„± ì˜¤ë¥˜ ë°œìƒ:');
                console.error('='.repeat(80));
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì „ì²´ ì˜¤ë¥˜ ê°ì²´:', error);
                if (typeof result !== 'undefined') {
                    console.error('ì„œë²„ ì‘ë‹µ:', result);
                }
                console.error('='.repeat(80));
                
                document.getElementById('errorData').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // í”„ë¡¬í”„íŠ¸ ë³µì‚¬ í•¨ìˆ˜
        function copyPrompt() {
            const promptContent = document.getElementById('promptContent');
            if (promptContent) {
                const textArea = document.createElement('textarea');
                textArea.value = promptContent.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ… ë³µì‚¬ë¨!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#007bff';
                }, 2000);
            }
        }

        // ì œë¯¸ë‚˜ì´ ì‘ë‹µ ë³µì‚¬ í•¨ìˆ˜
        function copyResponse() {
            const responseContent = document.getElementById('responseContent');
            if (responseContent) {
                const textArea = document.createElement('textarea');
                textArea.value = responseContent.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ… ë³µì‚¬ë¨!';
                button.style.background = '#198754';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#28a745';
                }, 2000);
            }
        }

        // ì…ë ¥ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displayInputResult(result) {
            const examContent = document.getElementById('examContent');
            const requestData = result.request_data;
            const distributionSummary = result.distribution_summary;
            const prompt = result.prompt;
            const llmResponse = result.llm_response;
            const llmError = result.llm_error;
            const subjectTypesValidation = result.subject_types_validation;
            
            let html = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="color: #28a745; margin-bottom: 15px;">âœ… ${result.message}</h2>`;
            
            // ë¶„ë°° ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (distributionSummary) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ“Š ë¬¸ì œ ë¶„ë°° ê²°ê³¼</h4>
                        <p><strong>ì´ ë¬¸ì œ ìˆ˜:</strong> ${distributionSummary.total_questions}ë¬¸ì œ</p>
                        <p><strong>ê²€ì¦ í†µê³¼:</strong> ${distributionSummary.validation_passed ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'}</p>
                        
                        <h5 style="margin-top: 15px;">ì˜ì—­ë³„ ë¶„ë°°:</h5>
                        ${distributionSummary.subject_distribution.map(item => 
                            `<p>â€¢ <strong>${item.subject}:</strong> ${item.count}ë¬¸ì œ (${item.ratio}%)</p>`
                        ).join('')}
                        
                        <h5 style="margin-top: 15px;">í˜•ì‹ë³„ ë¶„ë°°:</h5>
                        ${distributionSummary.format_distribution.map(item => 
                            `<p>â€¢ <strong>${item.format}:</strong> ${item.count}ë¬¸ì œ (${item.ratio}%)</p>`
                        ).join('')}
                        
                        <h5 style="margin-top: 15px;">ë‚œì´ë„ë³„ ë¶„ë°°:</h5>
                        ${distributionSummary.difficulty_distribution.map(item => 
                            `<p>â€¢ <strong>${item.difficulty}:</strong> ${item.count}ë¬¸ì œ (${item.ratio}%)</p>`
                        ).join('')}
                    </div>`;
            }
            
            // ì˜ì—­ë³„ ì¶œì œ ìœ í˜• ê²€ì¦ ê²°ê³¼
            if (subjectTypesValidation) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ¯ ì˜ì—­ë³„ ì¶œì œ ìœ í˜• í™•ì¸</h4>
                        ${subjectTypesValidation.reading_types.length > 0 ? 
                            `<p><strong>ğŸ“– ë…í•´ ìœ í˜•:</strong> ${subjectTypesValidation.reading_types.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.grammar_categories.length > 0 ? 
                            `<p><strong>ğŸ“ ë¬¸ë²• ì¹´í…Œê³ ë¦¬:</strong> ${subjectTypesValidation.grammar_categories.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.grammar_topics.length > 0 ? 
                            `<p><strong>ğŸ“ ë¬¸ë²• í† í”½:</strong> ${subjectTypesValidation.grammar_topics.join(', ')}</p>` : ''}
                        ${subjectTypesValidation.vocabulary_categories.length > 0 ? 
                            `<p><strong>ğŸ“š ì–´íœ˜ ì¹´í…Œê³ ë¦¬:</strong> ${subjectTypesValidation.vocabulary_categories.join(', ')}</p>` : ''}
                    </div>`;
            }
            
            // ì œë¯¸ë‚˜ì´ ì‘ë‹µ ê²°ê³¼ í‘œì‹œ
            if (llmResponse) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #28a745;">
                        <h3 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center;">
                            ğŸ¤– ì œë¯¸ë‚˜ì´ AI ì‘ë‹µ ê²°ê³¼
                            <button onclick="copyResponse()" style="margin-left: auto; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“‹ ë³µì‚¬</button>
                        </h3>
                        <div id="responseContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.4; max-height: 800px; overflow-y: auto; border: 1px solid #dee2e6;">${llmResponse}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            ğŸ¯ ì œë¯¸ë‚˜ì´ AIê°€ ìƒì„±í•œ ë¬¸ì œì§€ì…ë‹ˆë‹¤!
                        </div>
                    </div>`;
            }
            
            // LLM ì˜¤ë¥˜ í‘œì‹œ
            if (llmError) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #dc3545;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">âŒ AI ì‘ë‹µ ì˜¤ë¥˜</h3>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">${llmError}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            ğŸ’¡ API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                        </div>
                    </div>`;
            }
            
            // ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            if (prompt) {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #007bff;">
                        <h3 style="color: #007bff; margin-bottom: 15px; display: flex; align-items: center;">
                            ğŸš€ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
                            <button onclick="copyPrompt()" style="margin-left: auto; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“‹ ë³µì‚¬</button>
                        </h3>
                        <div id="promptContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.4; max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">${prompt}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            ğŸ’¡ ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ChatGPT, Claude, ë˜ëŠ” ë‹¤ë¥¸ AI ëª¨ë¸ì— ë¶™ì—¬ë„£ì–´ ì‚¬ìš©í•˜ì„¸ìš”!
                        </div>
                    </div>`;
            }
            
            html += `
                    <h3 style="color: #333; margin-top: 20px; margin-bottom: 10px;">ğŸ“‹ ì…ë ¥ë°›ì€ ë°ì´í„°:</h3>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ« ê¸°ë³¸ ì •ë³´</h4>
                        <p><strong>í•™êµê¸‰:</strong> ${requestData.school_level}</p>
                        <p><strong>í•™ë…„:</strong> ${requestData.grade}í•™ë…„</p>
                        <p><strong>ì´ ë¬¸ì œ ìˆ˜:</strong> ${requestData.total_questions}ê°œ</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ¯ ì„ íƒëœ ì˜ì—­</h4>
                        <p><strong>ì˜ì—­:</strong> ${requestData.subjects.join(', ')}</p>
                        
                        ${requestData.subject_details.reading_types.length > 0 ? 
                            `<p><strong>ğŸ“– ë…í•´ ìœ í˜•:</strong> ${requestData.subject_details.reading_types.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.grammar_categories.length > 0 ? 
                            `<p><strong>ğŸ“ ë¬¸ë²• ì¹´í…Œê³ ë¦¬:</strong> ${requestData.subject_details.grammar_categories.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.grammar_topics.length > 0 ? 
                            `<p><strong>ğŸ“ ë¬¸ë²• í† í”½:</strong> ${requestData.subject_details.grammar_topics.join(', ')}</p>` : ''}
                        
                        ${requestData.subject_details.vocabulary_categories.length > 0 ? 
                            `<p><strong>ğŸ“š ì–´íœ˜ ì¹´í…Œê³ ë¦¬:</strong> ${requestData.subject_details.vocabulary_categories.join(', ')}</p>` : ''}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">âš–ï¸ ì˜ì—­ë³„ ë¹„ìœ¨</h4>
                        ${requestData.subject_ratios.map(ratio => 
                            `<p><strong>${ratio.subject}:</strong> ${ratio.ratio}%</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ“‹ ë¬¸ì œ í˜•ì‹</h4>
                        <p><strong>ì„ íƒëœ í˜•ì‹:</strong> ${requestData.question_format}</p>
                        ${requestData.format_ratios.map(format => 
                            `<p><strong>${format.format}:</strong> ${format.ratio}%</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="color: #007bff;">ğŸ¯ ë‚œì´ë„ ë¶„ë°°</h4>
                        ${requestData.difficulty_distribution.map(diff => 
                            `<p><strong>${diff.difficulty}:</strong> ${diff.ratio}%</p>`
                        ).join('')}
                    </div>`;
            
            // ì¶”ê°€ ìš”êµ¬ì‚¬í•­ í‘œì‹œ
            if (requestData.additional_requirements) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 5px;">
                        <h4 style="color: #007bff;">ğŸ“ ì¶”ê°€ ìš”êµ¬ì‚¬í•­</h4>
                        <p style="background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 4px solid #007bff; white-space: pre-wrap;">${requestData.additional_requirements}</p>
                    </div>`;
            }
            
            html += `</div>
            `;
            
            examContent.innerHTML = html;
        }

        // ê¸°ì¡´ ë¬¸ì œì§€ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function displayExamResult(examData) {
            const examContent = document.getElementById('examContent');
            
            let html = `
                <div class="exam-section">
                    <div class="exam-title">ğŸ“‹ ì‹œí—˜ ì •ë³´</div>
                    <p><strong>í•™êµê¸‰:</strong> ${examData.exam_info.school_level}</p>
                    <p><strong>í•™ë…„:</strong> ${examData.exam_info.grade}í•™ë…„</p>
                    <p><strong>ì´ ë¬¸ì œ ìˆ˜:</strong> ${examData.exam_info.total_questions}ê°œ</p>
                    <p><strong>ì˜ì—­:</strong> ${examData.exam_info.subjects.join(', ')}</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('question-paper')">ğŸ“ ë¬¸ì œì§€</button>
                    <button class="tab" onclick="showTab('answer-sheet')">âœ… ë‹µì•ˆì§€</button>
                </div>

                <div id="question-paper" class="tab-content active">
            `;

            // ì§€ë¬¸ë“¤ì€ ê° ë¬¸ì œì™€ í•¨ê»˜ í‘œì‹œë˜ë¯€ë¡œ ë³„ë„ í‘œì‹œ ë¶ˆí•„ìš”

            // ë¬¸ì œë“¤ í‘œì‹œ (ì§€ë¬¸/ì˜ˆë¬¸ê³¼ í•¨ê»˜)
            if (examData.questions && examData.questions.length > 0) {
                html += '<div class="exam-section"><div class="exam-title">â“ ë¬¸ì œ</div>';
                examData.questions.forEach(question => {
                    html += `<div class="question">`;
                    
                    // ê´€ë ¨ ì§€ë¬¸ ì°¾ê¸° ë° í‘œì‹œ
                    if (question.passage_id && examData.passages) {
                        const relatedPassage = examData.passages.find(p => p.id === question.passage_id);
                        if (relatedPassage) {
                            html += `
                                <div class="passage-for-question">
                                    <div class="passage-title">ğŸ“– ì§€ë¬¸: ${relatedPassage.title}</div>
                                    <div class="passage-content">${relatedPassage.content}</div>
                                    <small>ë‹¨ì–´ ìˆ˜: ${relatedPassage.word_count}ê°œ</small>
                                </div>
                            `;
                        }
                    }
                    
                    // ê´€ë ¨ ì˜ˆë¬¸ ì°¾ê¸° ë° í‘œì‹œ  
                    if (question.example_id && examData.examples) {
                        const relatedExample = examData.examples.find(e => e.target_problem === `problem_${question.question_number}`);
                        if (relatedExample) {
                            html += `
                                <div class="example-for-question">
                                    <div class="example-title">ğŸ“ ì˜ˆë¬¸:</div>
                                    <div class="example-content">${relatedExample.content}</div>
                                </div>
                            `;
                        }
                    }
                    
                    // ì°¸ì¡° ë¬¸ì œì˜ ì§€ë¬¸ í‘œì‹œ (ê°™ì€ ì§€ë¬¸ì„ ì‚¬ìš©í•˜ëŠ” ì—°ì† ë¬¸ì œ)
                    if (question.reference_problem_id && !question.passage_id && !question.example_id) {
                        html += `
                            <div class="reference-note">
                                <small>â€» ìœ„ ì§€ë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ë¬¸ì œì…ë‹ˆë‹¤.</small>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="question-number">${question.question_number}ë²ˆ</div>
                        <p><strong>${question.question_text}</strong></p>
                    `;
                    
                    if (question.choices && question.choices.length > 0) {
                        html += '<div class="choices">';
                        question.choices.forEach(choice => {
                            html += `<p>${choice}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                        <small>ì˜ì—­: ${question.subject} | ë‚œì´ë„: ${question.difficulty} | í˜•ì‹: ${question.question_type}</small>
                    </div>`;
                });
                html += '</div>';
            }

            html += '</div>'; // question-paper ë

            // ë‹µì•ˆì§€ íƒ­
            html += '<div id="answer-sheet" class="tab-content">';
            
            if (examData.answer_sheet && examData.answer_sheet.answers) {
                html += '<div class="exam-section"><div class="exam-title">âœ… ì •ë‹µ ë° í•´ì„¤</div>';
                examData.answer_sheet.answers.forEach(answer => {
                    html += `
                        <div class="answer">
                            <div class="question-number">${answer.question_number}ë²ˆ</div>
                            <p><strong>ì •ë‹µ:</strong> ${answer.correct_answer}</p>
                            <div class="explanation">
                                <strong>í•´ì„¤:</strong> ${answer.explanation}
                            </div>
                            ${answer.key_points ? `
                                <div style="margin-top: 10px;">
                                    <strong>í•µì‹¬ í¬ì¸íŠ¸:</strong>
                                    <ul>
                                        ${answer.key_points.map(point => `<li>${point}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                // ì±„ì  ê¸°ì¤€
                if (examData.answer_sheet.grading_criteria) {
                    html += `
                        <div class="exam-section">
                            <div class="exam-title">ğŸ“Š ì±„ì  ê¸°ì¤€</div>
                            ${Object.entries(examData.answer_sheet.grading_criteria).map(([format, criteria]) => 
                                `<p><strong>${format}:</strong> ${criteria}</p>`
                            ).join('')}
                        </div>
                    `;
                }
            }

            html += '</div>'; // answer-sheet ë

            examContent.innerHTML = html;
        }

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ê³¼ ì½˜í…ì¸  í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            
            document.querySelectorAll('input[name="subjects"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSubjectDetails();
                    updateSubjectRatios();
                });
            });
            
            document.getElementById('questionFormat').addEventListener('change', updateFormatCounts);
            document.getElementById('totalQuestions').addEventListener('input', updateFormatCounts);
            
            document.getElementById('questionForm').addEventListener('submit', generateExam);
            
            // ì´ˆê¸° ì„¤ì •
            updateSubjectRatios();
            updateFormatCounts();
        });
    </script>
</body>
</html>
