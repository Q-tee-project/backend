/**
 * ë¬¸ì œì§€ í¸ì§‘ ë° ê´€ë¦¬ ëª¨ë“ˆ
 */

class WorksheetEditor {
    constructor() {
        this.worksheets = [];
        this.gradingResults = [];
        this.currentWorksheet = null;
        this.currentGradingResult = null;
        this.gradingEditMode = false;
        this.renderer = new WorksheetRenderer();
        this.startTime = Date.now(); // ë¬¸ì œì§€ ì‹œì‘ ì‹œê°„
        this.init();
    }

    async init() {
        // ApiServiceê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        await this.waitForApiService();
        this.setupTabNavigation();
        await this.loadWorksheets();
        await this.loadGradingResults();
    }

    // ApiService ë¡œë“œ ëŒ€ê¸°
    async waitForApiService() {
        return new Promise((resolve) => {
            const checkApiService = () => {
                if (typeof window.ApiService !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkApiService, 50);
                }
            };
            checkApiService();
        });
    }

    // íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
    setupTabNavigation() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                
                // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // ì„ íƒëœ íƒ­ í™œì„±í™”
                button.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
                
                // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
                this.handleTabSwitch(targetTab);
            });
        });
    }

    // íƒ­ ì „í™˜ ì²˜ë¦¬
    async handleTabSwitch(tabName) {
        switch (tabName) {
            case 'worksheets':
                await this.loadWorksheets();
                this.displayWorksheets();
                break;
            case 'results':
                await this.loadGradingResults();
                this.displayGradingResults();
                break;
            case 'generate':
                // ë¬¸ì œ ìƒì„± íƒ­ì€ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
                break;
        }
    }

    // ë¬¸ì œì§€ ëª©ë¡ ë¡œë“œ
    async loadWorksheets() {
        try {
            this.worksheets = await window.window.ApiService.getWorksheets();
            console.log('ë¬¸ì œì§€ ëª©ë¡ ë¡œë“œ:', this.worksheets);
        } catch (error) {
            console.error('ë¬¸ì œì§€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            this.showError('ë¬¸ì œì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„ì  ê²°ê³¼ ëª©ë¡ ë¡œë“œ
    async loadGradingResults() {
        try {
            this.gradingResults = await window.window.ApiService.getGradingResults();
            console.log('ì±„ì  ê²°ê³¼ ë¡œë“œ:', this.gradingResults);
        } catch (error) {
            console.error('ì±„ì  ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            this.showError('ì±„ì  ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ë¬¸ì œì§€ ëª©ë¡ í‘œì‹œ
    displayWorksheets() {
        const container = document.getElementById('worksheetsList');
        
        if (!this.worksheets || this.worksheets.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ“ ì €ì¥ëœ ë¬¸ì œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë¬¸ì œ ìƒì„± íƒ­ì—ì„œ ìƒˆë¡œìš´ ë¬¸ì œì§€ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                </div>
            `;
            return;
        }

        const html = this.worksheets.map(worksheet => 
            this.renderer.renderWorksheetCard(worksheet)
        ).join('');
        
        container.innerHTML = html;
    }

    // ì±„ì  ê²°ê³¼ í‘œì‹œ
    displayGradingResults() {
        const container = document.getElementById('gradingResults');
        
        if (!this.gradingResults || this.gradingResults.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ“Š ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë¬¸ì œì§€ë¥¼ í’€ê³  ë‹µì•ˆì„ ì œì¶œí•˜ë©´ ì±„ì  ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
            return;
        }

        const html = this.gradingResults.map(result => 
            this.renderer.renderGradingResultCard(result)
        ).join('');
        
        container.innerHTML = html;
    }

    // ë¬¸ì œì§€ ë³´ê¸°
    async viewWorksheet(worksheetId) {
        try {
            const result = await window.ApiService.getWorksheetForEdit(worksheetId);
            this.currentWorksheet = result.worksheet_data;
            
            this.showWorksheetModal(this.currentWorksheet, { 
                title: 'ğŸ“– ë¬¸ì œì§€ ë³´ê¸°',
                showAnswers: true,
                editMode: false 
            });
        } catch (error) {
            console.error('ë¬¸ì œì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
            this.showError('ë¬¸ì œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ë¬¸ì œì§€ í¸ì§‘
    async editWorksheet(worksheetId) {
        try {
            const result = await window.ApiService.getWorksheetForEdit(worksheetId);
            this.currentWorksheet = result.worksheet_data;
            
            this.showWorksheetModal(this.currentWorksheet, { 
                title: 'âœï¸ ë¬¸ì œì§€ í¸ì§‘',
                showAnswers: true,
                editMode: true 
            });
        } catch (error) {
            console.error('ë¬¸ì œì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
            this.showError('ë¬¸ì œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ë¬¸ì œì§€ í’€ì´
    async solveWorksheet(worksheetId) {
        try {
            const result = await window.ApiService.getWorksheetForSolve(worksheetId);
            const worksheetData = result.worksheet_data;
            
            this.showSolveModal(worksheetData);
        } catch (error) {
            console.error('ë¬¸ì œì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
            this.showError('ë¬¸ì œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ë¬¸ì œì§€ ì‚­ì œ
    async deleteWorksheet(worksheetId) {
        if (!confirm('ì •ë§ë¡œ ì´ ë¬¸ì œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            await window.ApiService.deleteWorksheet(worksheetId);
            this.showSuccess('ë¬¸ì œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await this.loadWorksheets();
            this.displayWorksheets();
        } catch (error) {
            console.error('ë¬¸ì œì§€ ì‚­ì œ ì˜¤ë¥˜:', error);
            this.showError('ë¬¸ì œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ë¬¸ì œì§€ ëª¨ë‹¬ í‘œì‹œ
    showWorksheetModal(worksheetData, options = {}) {
        const { title = 'ë¬¸ì œì§€', showAnswers = false, editMode = false } = options;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content worksheet-modal">
                <div class="modal-header">
                    <h2>${title}</h2>
                    <div class="modal-actions">
                        ${editMode ? `
                            <div class="edit-status">
                                <span class="auto-save-info">
                                    ğŸ’¡ ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤
                                </span>
                            </div>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="printWorksheet()">
                            ğŸ–¨ï¸ ì¸ì‡„
                        </button>
                        <button class="btn btn-outline modal-close">
                            âŒ ë‹«ê¸°
                        </button>
                    </div>
                </div>
                <div class="modal-body ${editMode ? 'edit-mode' : ''}">
                    ${this.renderer.renderWorksheet(worksheetData, { showAnswers, editMode })}
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // í¸ì§‘ ëª¨ë“œ ì„¤ì •
        if (editMode) {
            this.attachEditListeners(modal);
        }

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.remove();
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });

        // ì „ì—­ í•¨ìˆ˜ ì„¤ì •
        window.printWorksheet = () => this.printWorksheet();
    }

    // ë¬¸ì œì§€ í’€ì´ ëª¨ë‹¬
    showSolveModal(worksheetData) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content solve-modal">
                <div class="modal-header">
                    <h2>âœï¸ ë¬¸ì œì§€ í’€ì´</h2>
                    <div class="timer" id="solveTimer">
                        â±ï¸ ${worksheetData.worksheet_duration || 45}:00
                    </div>
                    <button class="btn btn-outline modal-close">âŒ ë‹«ê¸°</button>
                </div>
                <div class="modal-body">
                    <div class="solve-content">
                        <div class="worksheet-section">
                            ${this.renderer.renderWorksheet(worksheetData, { showAnswers: false, editMode: false })}
                        </div>
                        <div class="answer-section">
                            ${this.renderer.renderAnswerSheet(worksheetData)}
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // íƒ€ì´ë¨¸ ì‹œì‘
        this.startSolveTimer(worksheetData.worksheet_duration || 45);

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
        modal.querySelector('.modal-close').addEventListener('click', () => {
            if (confirm('í’€ì´ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‘ì„±í•œ ë‹µì•ˆì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                modal.remove();
            }
        });

        // ë‹µì•ˆ ì œì¶œ í•¨ìˆ˜ ì„¤ì •
        window.submitAnswers = () => this.submitAnswers(worksheetData.worksheet_id);
    }

    // í’€ì´ íƒ€ì´ë¨¸
    startSolveTimer(minutes) {
        let timeLeft = minutes * 60;
        const timerElement = document.getElementById('solveTimer');
        
        const timer = setInterval(() => {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            timerElement.textContent = `â±ï¸ ${mins}:${secs.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                alert('ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                this.submitAnswers();
            }
            
            timeLeft--;
        }, 1000);
    }

    // ë‹µì•ˆ ì œì¶œ
    async submitAnswers(worksheetId) {
        const answers = {};
        const inputs = document.querySelectorAll('.answer-input');
        
        inputs.forEach(input => {
            const questionId = input.dataset.questionId;
            const answer = input.value.trim();
            if (answer) {
                answers[questionId] = answer;
            }
        });

        if (Object.keys(answers).length === 0) {
            alert('ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ë‹µì•ˆì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            // ì†Œìš” ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
            const completionTime = Math.floor((Date.now() - this.startTime) / 1000) || 60; // ê¸°ë³¸ 60ì´ˆ
            
            const result = await window.ApiService.submitAnswers(worksheetId, {
                answers: answers,
                completion_time: completionTime
            });

            this.showSuccess('ë‹µì•ˆì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            document.querySelector('.modal-overlay').remove();
            
            // ì±„ì  ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
            await this.loadGradingResults();
            if (document.querySelector('.tab-btn[data-tab="results"]').classList.contains('active')) {
                this.displayGradingResults();
            }

        } catch (error) {
            console.error('ë‹µì•ˆ ì œì¶œ ì˜¤ë¥˜:', error);
            this.showError('ë‹µì•ˆ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // í¸ì§‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    attachEditListeners(container) {
        const editables = container.querySelectorAll('.editable');
        editables.forEach(element => {
            element.contentEditable = true;
            element.addEventListener('blur', (e) => this.handleEdit(e));
            element.addEventListener('keydown', (e) => this.handleEditKeydown(e));
        });
    }

    // í¸ì§‘ ì²˜ë¦¬
    async handleEdit(event) {
        const element = event.target;
        const type = element.dataset.type;
        const id = element.dataset.id;
        const newContent = element.textContent.trim();

        try {
            element.style.backgroundColor = '#fff3cd';
            
            const worksheetId = this.currentWorksheet.worksheet_id;
            
            switch (type) {
                case 'title':
                    await window.ApiService.updateWorksheetTitle(worksheetId, newContent);
                    this.currentWorksheet.worksheet_name = newContent;
                    break;
                    
                case 'question':
                    await window.ApiService.updateQuestionText(worksheetId, id, newContent);
                    break;
                    
                case 'choice':
                    const choiceIndex = parseInt(element.dataset.choiceIndex);
                    const questionId = element.dataset.questionId;
                    await window.ApiService.updateQuestionChoice(worksheetId, questionId, choiceIndex, newContent);
                    break;
                    
                case 'answer':
                    await window.ApiService.updateQuestionAnswer(worksheetId, id, newContent);
                    break;
                    
                case 'passage':
                    const passageContent = this.parsePassageContent(element);
                    await window.ApiService.updatePassage(worksheetId, id, passageContent);
                    break;
                    
                case 'example':
                    await window.ApiService.updateExample(worksheetId, id, newContent);
                    break;
            }

            element.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                element.style.backgroundColor = '';
            }, 1000);

        } catch (error) {
            console.error('í¸ì§‘ ì €ì¥ ì˜¤ë¥˜:', error);
            element.style.backgroundColor = '#f8d7da';
            setTimeout(() => {
                element.style.backgroundColor = '';
            }, 2000);
            this.showError('í¸ì§‘ ë‚´ìš© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // í¸ì§‘ í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    handleEditKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            event.target.blur();
        }
    }

    // ì§€ë¬¸ ë‚´ìš© íŒŒì‹± (JSON í˜•ì‹ ìœ ì§€)
    parsePassageContent(element) {
        const content = [];
        const children = element.children;
        
        for (let child of children) {
            if (child.tagName === 'H3') {
                content.push({ type: 'title', value: child.textContent });
            } else if (child.tagName === 'P') {
                content.push({ type: 'paragraph', value: child.textContent });
            }
        }
        
        return { 
            content: content.length > 0 ? content : [{ type: 'paragraph', value: element.textContent }] 
        };
    }

    // ì±„ì  ìˆ˜ì • ëª¨ë“œ í† ê¸€
    toggleGradingEditMode() {
        this.gradingEditMode = !this.gradingEditMode;
        
        if (this.currentGradingResult && this.currentWorksheetData) {
            this.renderGradingResult(this.currentGradingResult, this.currentWorksheetData);
        }
    }

    // ë¬¸ì œë³„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (ë©”ëª¨ë¦¬ì—ì„œë§Œ)
    updateQuestionScore(questionId, newScore, maxScore) {
        const score = Math.max(0, Math.min(parseInt(newScore) || 0, maxScore));
        
        if (this.currentGradingResult && this.currentGradingResult.question_results) {
            const questionResult = this.currentGradingResult.question_results.find(qr => qr.question_id === questionId);
            if (questionResult) {
                questionResult.score = score;
                questionResult.is_correct = score >= Math.ceil(maxScore * 0.6); // 60% ì´ìƒì„ ì •ë‹µìœ¼ë¡œ ê°„ì£¼
                
                // ì´ì  ì¬ê³„ì‚°
                this.recalculateTotalScore();
            }
        }
    }

    // ì´ì  ì¬ê³„ì‚°
    recalculateTotalScore() {
        if (this.currentGradingResult && this.currentGradingResult.question_results) {
            const totalScore = this.currentGradingResult.question_results.reduce((sum, qr) => sum + qr.score, 0);
            const maxScore = this.currentGradingResult.question_results.reduce((sum, qr) => sum + qr.max_score, 0);
            
            this.currentGradingResult.total_score = totalScore;
            this.currentGradingResult.percentage = maxScore > 0 ? (totalScore / maxScore * 100) : 0;
            
            // í—¤ë”ì˜ ì ìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸
            this.updateScoreDisplay();
        }
    }

    // ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateScoreDisplay() {
        const totalScoreElement = document.querySelector('.score-summary .score');
        const percentageElement = document.querySelector('.score-summary .percentage');
        
        if (totalScoreElement && this.currentGradingResult) {
            totalScoreElement.textContent = `${this.currentGradingResult.total_score} / ${this.currentGradingResult.max_score}ì `;
        }
        
        if (percentageElement && this.currentGradingResult) {
            percentageElement.textContent = `${this.currentGradingResult.percentage.toFixed(1)}%`;
        }
    }

    // ì±„ì  ìˆ˜ì •ì‚¬í•­ ì €ì¥
    async saveGradingChanges() {
        try {
            // í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
            const feedbackInputs = document.querySelectorAll('.feedback-input');
            const questionReviews = {};
            
            // ì ìˆ˜ì™€ í”¼ë“œë°± ìˆ˜ì§‘
            if (this.currentGradingResult && this.currentGradingResult.question_results) {
                this.currentGradingResult.question_results.forEach(qr => {
                    const feedbackInput = document.querySelector(`.feedback-input[data-question-id="${qr.question_id}"]`);
                    const feedback = feedbackInput ? feedbackInput.value.trim() : qr.ai_feedback;
                    
                    questionReviews[qr.question_id] = {
                        score: qr.score,
                        feedback: feedback
                    };
                });
            }
            
            // API í˜¸ì¶œ
            const result = await window.ApiService.reviewGrading(this.currentGradingResult.result_id, {
                question_results: questionReviews,
                reviewed_by: "êµì‚¬"
            });
            
            this.showSuccess('ì±„ì  ìˆ˜ì •ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ìˆ˜ì • ëª¨ë“œ í•´ì œ
            this.gradingEditMode = false;
            this.renderGradingResult(this.currentGradingResult, this.currentWorksheetData);
            
        } catch (error) {
            console.error('ì±„ì  ìˆ˜ì •ì‚¬í•­ ì €ì¥ ì˜¤ë¥˜:', error);
            this.showError('ì±„ì  ìˆ˜ì •ì‚¬í•­ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê°œë³„ í¸ì§‘ì´ ìë™ì €ì¥ë˜ë¯€ë¡œ ë³„ë„ ì €ì¥ í•¨ìˆ˜ ë¶ˆí•„ìš”
    // ëª¨ë“  ë³€ê²½ì‚¬í•­ì€ handleEdit()ì—ì„œ ì¦‰ì‹œ ì„œë²„ì— ì €ì¥ë¨

    // ë¬¸ì œì§€ ì¸ì‡„
    printWorksheet() {
        const printContent = this.renderer.renderForPrint(this.currentWorksheet);
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>ë¬¸ì œì§€ ì¸ì‡„</title>
                <link rel="stylesheet" href="/static/css/style.css">
            </head>
            <body>
                ${printContent}
                <script>window.print(); window.close();</script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    // ì±„ì  ê²°ê³¼ ë³´ê¸°
    async viewGradingResult(resultId) {
        try {
            const result = await window.ApiService.getGradingResult(resultId);
            this.showGradingResultModal(result);
        } catch (error) {
            console.error('ì±„ì  ê²°ê³¼ ì¡°íšŒ ì˜¤ë¥˜:', error);
            this.showError('ì±„ì  ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„ì  ê²°ê³¼ ëª¨ë‹¬
    showGradingResultModal(result) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content grading-modal">
                <div class="modal-header">
                    <h2>ğŸ“Š ì±„ì  ê²°ê³¼</h2>
                    <button class="btn btn-outline modal-close">âŒ ë‹«ê¸°</button>
                </div>
                <div class="modal-body">
                    <div class="result-summary">
                        <h3>${result.student_name}ë‹˜ì˜ ë‹µì•ˆ</h3>
                        <p><strong>ì ìˆ˜:</strong> ${result.total_score} / ${result.max_score}ì </p>
                        <p><strong>ì œì¶œì¼:</strong> ${this.renderer.formatDate(result.submitted_at)}</p>
                    </div>
                    <div class="result-details">
                        <!-- ìƒì„¸ ì±„ì  ê²°ê³¼ í‘œì‹œ -->
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.remove();
        });
    }

    // ì„±ê³µ ë©”ì‹œì§€
    showSuccess(message) {
        this.showMessage(message, 'success');
    }

    // ì˜¤ë¥˜ ë©”ì‹œì§€
    showError(message) {
        this.showMessage(message, 'error');
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    showMessage(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            max-width: 400px;
            word-wrap: break-word;
            ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
        `;
        alertDiv.textContent = message;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // ì±„ì  ê²°ê³¼ ë³´ê¸° (ë‹¨ì¼ API í˜¸ì¶œ)
    async viewGradingResult(resultId) {
        try {
            console.log('ì±„ì  ê²°ê³¼ ì¡°íšŒ:', resultId);
            
            // ì±„ì  ê²°ê³¼ + ë¬¸ì œì§€ ë°ì´í„° í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
            const gradingResult = await window.ApiService.getGradingResult(resultId);
            console.log('ì±„ì  ê²°ê³¼ ë°ì´í„° (ë¬¸ì œì§€ í¬í•¨):', gradingResult);
            
            // ë¬¸ì œì§€ ë°ì´í„°ëŠ” ì´ì œ gradingResult.worksheet_dataì— í¬í•¨ë¨
            const worksheetData = gradingResult.worksheet_data;
            
            // í˜„ì¬ ì±„ì  ê²°ê³¼ ì €ì¥
            this.currentGradingResult = gradingResult;
            this.currentWorksheetData = worksheetData;
            
            // ì±„ì  ê²°ê³¼ ë Œë”ë§
            this.renderGradingResult(gradingResult, worksheetData);
            
        } catch (error) {
            console.error('ì±„ì  ê²°ê³¼ ì¡°íšŒ ì˜¤ë¥˜:', error);
            this.showError('ì±„ì  ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„ì  ê²°ê³¼ ë Œë”ë§
    renderGradingResult(gradingResult, worksheetData) {
        const content = document.getElementById('worksheetContent');
        
        // í—¤ë” ì •ë³´
        let html = `
            <div class="grading-result-header">
                <h2>ğŸ“Š ì±„ì  ê²°ê³¼</h2>
                <div class="score-summary">
                    <div class="score-item">
                        <span class="label">í•™ìƒ:</span>
                        <span class="value">${gradingResult.student_name}</span>
                    </div>
                    <div class="score-item">
                        <span class="label">ì´ì :</span>
                        <span class="value score">${gradingResult.total_score} / ${gradingResult.max_score}ì </span>
                    </div>
                    <div class="score-item">
                        <span class="label">ì •ë‹µë¥ :</span>
                        <span class="value percentage">${gradingResult.percentage.toFixed(1)}%</span>
                    </div>
                    <div class="score-item">
                        <span class="label">ì†Œìš”ì‹œê°„:</span>
                        <span class="value">${Math.floor(gradingResult.completion_time / 60)}ë¶„ ${gradingResult.completion_time % 60}ì´ˆ</span>
                    </div>
                </div>
                <div class="grading-actions">
                    <button class="btn btn-primary" onclick="window.worksheetEditor.toggleGradingEditMode()">
                        ${this.gradingEditMode ? 'ğŸ“– ë³´ê¸° ëª¨ë“œ' : 'âœï¸ ì±„ì  ìˆ˜ì • ëª¨ë“œ'}
                    </button>
                    ${this.gradingEditMode ? `
                        <button class="btn btn-success" onclick="window.worksheetEditor.saveGradingChanges()">
                            ğŸ’¾ ì±„ì  ìˆ˜ì •ì‚¬í•­ ì €ì¥
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="window.worksheetEditor.showGradingResultsList()">
                        â† ì±„ì  ê²°ê³¼ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            </div>
        `;

        // ë¬¸ì œì§€ ì •ë³´
        html += `
            <div class="worksheet-info">
                <h3>${worksheetData.worksheet_name}</h3>
                <p><strong>í•™êµê¸‰:</strong> ${worksheetData.worksheet_level} | 
                   <strong>í•™ë…„:</strong> ${worksheetData.worksheet_grade}í•™ë…„ | 
                   <strong>ë¬¸ì œ ìˆ˜:</strong> ${worksheetData.total_questions}ë¬¸ì œ</p>
            </div>
        `;

        // ë¬¸ì œë³„ ì±„ì  ê²°ê³¼ì™€ í•¨ê»˜ ë¬¸ì œì§€ ë Œë”ë§
        html += this.renderWorksheetWithGradingResult(worksheetData, gradingResult);
        
        content.innerHTML = html;
        
        // ê²°ê³¼ í™”ë©´ í‘œì‹œ
        document.getElementById('generatedWorksheet').style.display = 'block';
        document.getElementById('generatedWorksheet').scrollIntoView({ behavior: 'smooth' });
    }

    // ì±„ì  ê²°ê³¼ì™€ í•¨ê»˜ ë¬¸ì œì§€ ë Œë”ë§
    renderWorksheetWithGradingResult(worksheetData, gradingResult) {
        let html = '';
        
        // ë¬¸ì œë³„ë¡œ ì—°ê´€ëœ ì§€ë¬¸/ì˜ˆë¬¸ê³¼ í•¨ê»˜ ë Œë”ë§
        const renderedPassages = new Set();
        const renderedExamples = new Set();
        
        if (worksheetData.questions && worksheetData.questions.length > 0) {
            worksheetData.questions.forEach((question, index) => {
                // í•´ë‹¹ ë¬¸ì œì™€ ì—°ê´€ëœ ì§€ë¬¸ ë¨¼ì € ë Œë”ë§
                if (question.question_passage_id) {
                    const passage = worksheetData.passages?.find(p => p.passage_id === question.question_passage_id);
                    if (passage && !renderedPassages.has(passage.passage_id)) {
                        html += this.renderer.renderPassage(passage, false);
                        renderedPassages.add(passage.passage_id);
                    }
                }
                
                // í•´ë‹¹ ë¬¸ì œì™€ ì—°ê´€ëœ ì˜ˆë¬¸ ë¨¼ì € ë Œë”ë§
                if (question.question_example_id) {
                    const example = worksheetData.examples?.find(e => e.example_id === question.question_example_id);
                    if (example && !renderedExamples.has(example.example_id)) {
                        html += this.renderer.renderExample(example, false);
                        renderedExamples.add(example.example_id);
                    }
                }
                
                // ë¬¸ì œ ë Œë”ë§ (ì±„ì  ê²°ê³¼ í¬í•¨)
                html += this.renderQuestionWithResult(question, index + 1, gradingResult);
            });
        }
        
        return html;
    }

    // ì±„ì  ê²°ê³¼ì™€ í•¨ê»˜ ë¬¸ì œ ë Œë”ë§ (í•™ìƒ ë‹µì•ˆê³¼ í”¼ë“œë°± í¬í•¨)
    renderQuestionWithResult(question, number, gradingResult) {
        const questionResult = gradingResult.question_results?.find(qr => qr.question_id === question.question_id);
        const studentAnswer = gradingResult.student_answers?.[question.question_id] || 'ë‹µì•ˆ ì—†ìŒ';
        const correctAnswer = questionResult?.correct_answer || 'ì •ë‹µ ì—†ìŒ';
        const aiFeedback = questionResult?.ai_feedback;
        const isCorrect = questionResult?.is_correct || false;
        const score = questionResult?.score || 0;
        const maxScore = questionResult?.max_score || 1;
        const gradingMethod = questionResult?.grading_method || 'unknown';
        
        // ë””ë²„ê¹…ìš© ë¡œê·¸
        console.log(`ë¬¸ì œ ${question.question_id}: í•™ìƒë‹µì•ˆ="${studentAnswer}", ì •ë‹µ="${correctAnswer}", ì±„ì ê²°ê³¼=`, questionResult);
        
        let html = `
            <div class="question grading-result-question ${isCorrect ? 'correct' : 'incorrect'}">
                <div class="question-header">
                    <span class="question-number">${number}.</span>
                    <span class="question-info">
                        ${question.question_subject} | ${question.question_difficulty} | ${question.question_type}
                    </span>
                    <span class="question-score ${isCorrect ? 'correct' : 'incorrect'}">
                        ${this.gradingEditMode ? `
                            <div class="score-edit-container">
                                <input type="number" 
                                       class="score-input" 
                                       value="${score}" 
                                       min="0" 
                                       max="${maxScore}" 
                                       data-question-id="${question.question_id}"
                                       onchange="window.worksheetEditor.updateQuestionScore('${question.question_id}', this.value, ${maxScore})">
                                / ${maxScore}ì 
                                <label class="correct-toggle">
                                    <input type="checkbox" 
                                           class="correct-checkbox"
                                           data-question-id="${question.question_id}"
                                           ${isCorrect ? 'checked' : ''}
                                           onchange="window.worksheetEditor.toggleQuestionCorrect('${question.question_id}', this.checked, ${maxScore})">
                                    <span class="correct-label">ì •ë‹µ ì¸ì •</span>
                                </label>
                            </div>
                        ` : `${score} / ${maxScore}ì  ${isCorrect ? 'âœ…' : 'âŒ'}`}
                    </span>
                </div>
                <div class="question-text">
                    ${this.renderer.escapeHtml(question.question_text || '')}
                </div>
        `;

        // ì„ íƒì§€ ë Œë”ë§ (í•™ìƒ ë‹µì•ˆê³¼ ì •ë‹µ í‘œì‹œ)
        if (question.question_choices && question.question_choices.length > 0) {
            html += '<div class="question-choices">';
            question.question_choices.forEach((choice, index) => {
                const marker = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤'][index] || `${index + 1}.`;
                const isStudentChoice = studentAnswer === (index + 1).toString() || studentAnswer === marker;
                const isCorrectChoice = correctAnswer === (index + 1).toString() || correctAnswer === marker;
                
                let choiceClass = 'choice';
                if (isStudentChoice && isCorrectChoice) {
                    choiceClass += ' student-correct'; // í•™ìƒì´ ì„ íƒí•˜ê³  ì •ë‹µ
                } else if (isStudentChoice && !isCorrectChoice) {
                    choiceClass += ' student-wrong'; // í•™ìƒì´ ì„ íƒí–ˆì§€ë§Œ í‹€ë¦¼
                } else if (!isStudentChoice && isCorrectChoice) {
                    choiceClass += ' correct-answer'; // ì •ë‹µì´ì§€ë§Œ í•™ìƒì´ ì„ íƒ ì•ˆí•¨
                }
                
                html += `
                    <div class="${choiceClass}">
                        <span class="choice-marker">${marker}</span>
                        <span class="choice-text">
                            ${this.renderer.escapeHtml(choice)}
                        </span>
                        ${isStudentChoice ? '<span class="student-mark">ğŸ‘¤</span>' : ''}
                        ${isCorrectChoice ? '<span class="correct-mark">âœ…</span>' : ''}
                    </div>
                `;
            });
            html += '</div>';
        } else {
            // ì£¼ê´€ì‹/ì„œìˆ í˜• ë‹µì•ˆ
            html += `
                <div class="answer-comparison">
                    <div class="student-answer">
                        <strong>í•™ìƒ ë‹µì•ˆ:</strong> 
                        <span class="answer-text ${isCorrect ? 'correct' : 'incorrect'}">
                            ${this.renderer.escapeHtml(studentAnswer || 'ë¯¸ì‘ì„±')}
                        </span>
                    </div>
                    <div class="correct-answer">
                        <strong>ì •ë‹µ:</strong> 
                        <span class="answer-text">
                            ${this.renderer.escapeHtml(correctAnswer || '')}
                        </span>
                    </div>
                </div>
            `;
        }

        // í•´ì„¤ í‘œì‹œ
        if (question.explanation) {
            html += `
                <div class="question-explanation">
                    <strong>í•´ì„¤:</strong> 
                    <span>${this.renderer.escapeHtml(question.explanation)}</span>
                </div>
            `;
        }

        // ì±„ì  ì •ë³´ í‘œì‹œ
        html += `
            <div class="grading-info">
                <div class="grading-details">
                    <span class="grading-method">ì±„ì  ë°©ì‹: ${gradingMethod === 'ai' ? 'ğŸ¤– AI ì±„ì ' : 'ğŸ“Š DB ë¹„êµ'}</span>
                    <span class="score-display">ì ìˆ˜: ${score} / ${maxScore}ì </span>
                </div>
            </div>
        `;

        // AI í”¼ë“œë°± (ìˆëŠ” ê²½ìš°)
        if (aiFeedback) {
            html += `
                <div class="ai-feedback">
                    <strong>ğŸ¤– AI í”¼ë“œë°±:</strong> 
                    ${this.gradingEditMode ? `
                        <textarea class="feedback-input" 
                                  data-question-id="${question.question_id}"
                                  placeholder="AI í”¼ë“œë°±ì„ ìˆ˜ì •í•˜ì„¸ìš”..."
                                  onblur="window.worksheetEditor.updateQuestionFeedback('${question.question_id}', this.value)"
                        >${aiFeedback}</textarea>
                    ` : `
                        <div class="feedback-text">${this.renderer.escapeHtml(aiFeedback)}</div>
                    `}
                </div>
            `;
        } else if (this.gradingEditMode && gradingMethod === 'ai') {
            // AI ì±„ì  ë¬¸ì œì¸ë° í”¼ë“œë°±ì´ ì—†ëŠ” ê²½ìš° ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡
            html += `
                <div class="ai-feedback">
                    <strong>ğŸ¤– AI í”¼ë“œë°± ì¶”ê°€:</strong>
                    <textarea class="feedback-input" 
                              data-question-id="${question.question_id}"
                              placeholder="AI í”¼ë“œë°±ì„ ì¶”ê°€í•˜ì„¸ìš”..."
                              onblur="window.worksheetEditor.updateQuestionFeedback('${question.question_id}', this.value)"
                    ></textarea>
                </div>
            `;
        }

        html += `</div>`;
        return html;
    }

    // AI í”¼ë“œë°± ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
    updateQuestionFeedback(questionId, feedback) {
        // í˜„ì¬ ì±„ì  ê²°ê³¼ì—ì„œ í•´ë‹¹ ë¬¸ì œ ì°¾ê¸°
        const questionResult = this.currentGradingResult?.question_results?.find(qr => qr.question_id === questionId);
        if (questionResult) {
            questionResult.ai_feedback = feedback;
            console.log(`ë¬¸ì œ ${questionId} í”¼ë“œë°± ì—…ë°ì´íŠ¸:`, feedback);
            // TODO: ì„œë²„ì— ì €ì¥í•˜ëŠ” API í˜¸ì¶œ ì¶”ê°€
        }
    }

    // ì±„ì  ê²°ê³¼ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    showGradingResultsList() {
        // ì±„ì  ê²°ê³¼ íƒ­ í™œì„±í™”
        const resultTab = document.querySelector('.tab-btn[data-tab="results"]');
        const worksheetContent = document.getElementById('worksheetContent');
        const generatedWorksheet = document.getElementById('generatedWorksheet');
        
        if (resultTab) {
            resultTab.click();
        } else {
            // ìˆ˜ë™ìœ¼ë¡œ ì±„ì  ê²°ê³¼ íƒ­ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const resultTabContent = document.getElementById('results-tab');
            if (resultTabContent) {
                resultTabContent.classList.add('active');
                this.displayGradingResults();
            }
        }
        
        // ì›Œí¬ì‹œíŠ¸ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
        if (worksheetContent) {
            worksheetContent.innerHTML = '';
        }
        
        if (generatedWorksheet) {
            generatedWorksheet.style.display = 'none';
        }
    }

    // ì •ë‹µ ì¸ì • í† ê¸€ ê¸°ëŠ¥
    async toggleQuestionCorrect(questionId, isCorrect) {
        try {
            if (!this.currentGradingResult) {
                console.error('í˜„ì¬ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            console.log(`ë¬¸ì œ ${questionId} ì •ë‹µ ì¸ì • ìƒíƒœ ë³€ê²½: ${isCorrect}`);

            // API í˜¸ì¶œ
            const reviewData = {
                question_results: {
                    [questionId]: {
                        is_correct: isCorrect
                    }
                }
            };

            const response = await ApiService.updateGradingReview(
                this.currentGradingResult.result_id, 
                reviewData
            );

            if (response) {
                console.log('ì •ë‹µ ì¸ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ:', response);
                
                // í˜„ì¬ ì±„ì  ê²°ê³¼ ì—…ë°ì´íŠ¸
                const questionResult = this.currentGradingResult.question_results.find(
                    qr => qr.question_id === questionId
                );
                
                if (questionResult) {
                    questionResult.is_correct = isCorrect;
                    // ì ìˆ˜ë„ ì—…ë°ì´íŠ¸ (ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ ê°’ ë°˜ì˜)
                    if (response.total_score !== undefined) {
                        this.currentGradingResult.total_score = response.total_score;
                        this.currentGradingResult.percentage = response.percentage;
                    }
                }

                // UI ìƒˆë¡œê³ ì¹¨
                this.renderGradingResultView();
                
                // ì„±ê³µ í”¼ë“œë°±
                this.showNotification('ì •ë‹µ ì¸ì • ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

        } catch (error) {
            console.error('ì •ë‹µ ì¸ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            this.showNotification('ì •ë‹µ ì¸ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë˜ëŒë¦¬ê¸°
            const checkbox = document.querySelector(`input[data-question-id="${questionId}"]`);
            if (checkbox) {
                checkbox.checked = !isCorrect;
            }
        }
    }

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        `;
        
        if (type === 'success') {
            notification.style.backgroundColor = '#28a745';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#dc3545';
        } else {
            notification.style.backgroundColor = '#007bff';
        }
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

// ì „ì—­ í•¨ìˆ˜ë“¤
window.viewWorksheet = (id) => window.worksheetEditor.viewWorksheet(id);
window.editWorksheet = (id) => window.worksheetEditor.editWorksheet(id);
window.solveWorksheet = (id) => window.worksheetEditor.solveWorksheet(id);
window.deleteWorksheet = (id) => window.worksheetEditor.deleteWorksheet(id);
window.viewGradingResult = (id) => window.worksheetEditor.viewGradingResult(id);

// ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.WorksheetEditor = WorksheetEditor;
