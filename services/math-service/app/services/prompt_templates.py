"""
AI 프롬프트 템플릿 관리 모듈 - 쎈 교재 스타일
"""
from typing import Dict, List

class PromptTemplates:
    """AI 프롬프트 템플릿 관리 클래스"""
    
    @staticmethod
    def get_difficulty_criteria() -> str:
        """난이도 기준 정의 - 쎈 교재 스타일"""
        return """
**[쎈 교재 스타일 난이도 기준]**

**A단계 (기본 개념)** - 정답률 80~90%:
- **특징**: 공식에 바로 대입하는 1~2단계 계산
- **문제 길이**: 1~2줄
- **예시 유형**:
  * 일차방정식: $2x + 3 = 7$ 풀기
  * 다항식 계산: $(3x + 2) - (x - 1)$ 정리하기
  * 분수 계산: $\\frac{2}{3} + \\frac{1}{4}$ 구하기
  * 지수법칙: $2^3 \\times 2^2$ 계산하기
- **해설**: 1~2문장 (핵심 계산만)

**B단계 (유형 적용)** - 정답률 50~60%:
- **특징**: 개념 2~3개 결합, 실생활 응용, 3~4단계 풀이
- **문제 길이**: 3~4줄
- **예시 유형**:
  * 농도 문제: "10% 소금물 200g에 물을 더 넣어 5%로 만들려면?"
  * 속력 문제: "시속 60km로 2시간, 시속 80km로 1시간 30분 달렸을 때..."
  * 일의 양: "A가 혼자 하면 12일, B가 혼자 하면 18일..."
  * 도형 응용: "정사각형의 한 변을 2cm 늘이고 다른 변을 3cm 줄였더니..."
- **해설**: 2~3문장 (핵심 단계 설명)

**C단계 (심화 사고)** - 정답률 20~30%:
- **특징**: 창의적 접근 필요, 다단계 추론, 여러 개념 통합
- **문제 길이**: 5~7줄
- **예시 유형**:
  * 규칙성 찾기: "1, 1, 2, 3, 5, 8, ... 의 100번째 항을 10으로 나눈 나머지는?"
  * 최적화: "직사각형 둘레가 20일 때 넓이의 최댓값과 그때의 가로, 세로 길이는?"
  * 증명: "$n^2 + n$이 항상 짝수임을 증명하고, 이를 이용한 응용 문제"
  * 복합 도형: "정삼각형 내부의 점 P에서 각 꼭짓점까지 거리의 합의 최솟값"
- **해설**: 3~4문장 (핵심 아이디어 + 주요 단계)
"""

    @staticmethod
    def get_generation_rules() -> str:
        """문제 생성 규칙 - KaTeX 최적화"""
        return """
**[쎈 스타일 문제 생성 규칙]**

1. **난이도 분배 엄수**
   - 요청된 A:B:C 비율 정확히 지키기
   - difficulty 필드: "A", "B", "C"로 명확히 구분
   - 난이도 간 확실한 차별화 필수

2. **KaTeX 수식 작성법 (매우 중요)**
   ```
   올바른 예시:
   - 분수: $\\frac{3}{4}$, $\\frac{x+1}{x-2}$
   - 제곱: $x^2$, $2^{10}$, $(x+1)^2$
   - 제곱근: $\\sqrt{16}$, $\\sqrt{x^2+1}$
   - 곱셈: $3 \\times 4$, $2 \\cdot 3$
   - 나눗셈: $6 \\div 2$, $\\frac{a}{b}$
   - 부등호: $x \\leq 5$, $a \\geq b$
   - 삼각함수: $\\sin\\theta$, $\\cos 30°$
   - 로그: $\\log_2 8$, $\\ln x$
   - 집합: $\\{1, 2, 3\\}$, $x \\in A$
   - 절댓값: $|x-3|$, $|-5|$
   
   절대 금지:
   - 불완전한 명령어: \\f, \\s, rac{}, qrt{}
   - 이스케이프 누락: frac{3}{4} (X) → $\\frac{3}{4}$ (O)
   - 중괄호 누락: x^12 (X) → $x^{12}$ (O)
   - 달러 기호 누락: \\frac{1}{2} (X) → $\\frac{1}{2}$ (O)
   ```

3. **문제 작성 스타일**
   - A단계: "다음을 계산하시오:", "~을 구하시오."
   - B단계: 실생활 상황 제시 → 수학적 해결
   - C단계: 조건 제시 → 추론 요구 → 증명/설명

4. **해설 작성 규칙**
   - A단계: 핵심 계산만 (예: "$3x = 6$이므로 $x = 2$")
   - B단계: 식 세우기 + 계산 (예: "속력×시간=거리이므로 $60 \\times 2 = 120$km")
   - C단계: 핵심 아이디어 + 과정 (예: "홀수는 $2n+1$로 표현하면...")
   
5. **금지 표현 (해설에서)**
   - AI 사고과정: "확인해보겠습니다", "접근해보면", "문제 재설계"
   - 불확실성: "~인 것 같다", "~로 보인다"
   - 수정 과정: "다시 계산하면", "처음에는"
   - 메타 설명: "이 문제는", "여기서 주의할 점은"

6. **correct_answer 형식**
   - 객관식: "A", "B", "C", "D" (①②③④ 금지)
   - 단답형: "$x = 3$", "15", "$2x + 1$"
   - 서술형: 완전한 풀이 과정 포함

7. **선택지 작성 (객관식)**
   - choices: ["내용1", "내용2", "내용3", "내용4"]
   - 매력적인 오답 포함 (계산 실수 유도)
   - 수식도 $로 감싸기: ["$x = 2$", "$x = 3$", "$x = 4$", "$x = 5$"]
"""

    @staticmethod
    def get_difficulty_requirements() -> str:
        """쎈 스타일 난이도별 예시"""
        return """
**[쎈 교재 스타일 난이도별 구체적 예시]**

**A단계 (기본) - 바로 풀 수 있는 문제**
```
문제 1: 일차방정식 $3x - 7 = 8$을 풀어라.
해설: 양변에 7을 더하면 $3x = 15$, 따라서 $x = 5$

문제 2: $(2x + 3) + (x - 5)$를 간단히 하여라.
해설: 동류항끼리 정리하면 $3x - 2$

문제 3: $\\frac{3}{5} \\times \\frac{10}{9}$를 계산하여라.
해설: 약분하면 $\\frac{2}{3}$
```

**B단계 (유형) - 개념 응용이 필요한 문제**
```
문제 1: 농도가 20%인 소금물 300g에 물 100g을 더 넣었다. 
       새로운 소금물의 농도는 몇 %인가?
해설: 소금의 양은 $300 \\times 0.2 = 60$g으로 일정하다.
     새 소금물은 400g이므로 농도는 $\\frac{60}{400} \\times 100 = 15$%

문제 2: 연속하는 세 홀수의 합이 57일 때, 가장 큰 수를 구하여라.
해설: 세 홀수를 $2n-1, 2n+1, 2n+3$으로 놓으면 합이 $6n+3=57$
     따라서 $n=9$이고 가장 큰 수는 21

문제 3: 정가의 20%를 할인한 가격이 12,000원일 때, 정가를 구하여라.
해설: 정가를 $x$원이라 하면 $0.8x = 12000$
     따라서 $x = 15000$원
```

**C단계 (심화) - 사고력이 필요한 문제**
```
문제 1: 1부터 100까지의 자연수 중에서 3의 배수이거나 5의 배수인 
       수의 개수를 구하고, 그 합을 구하여라.
해설: 3의 배수 33개, 5의 배수 20개, 15의 배수 6개로 포함배제원리 적용.
     개수는 $33+20-6=47$개, 합은 등차수열 공식으로 계산.

문제 2: 좌표평면에서 점 $(2, 3)$을 $x$축에 대해 대칭이동한 후,
       원점을 중심으로 90° 회전시킨 점의 좌표를 구하여라.
해설: $x$축 대칭으로 $(2, -3)$이 되고, 90° 회전으로 $(3, 2)$가 된다.
     회전변환 행렬 적용하면 확인 가능.

문제 3: $n$이 자연수일 때, $\\frac{n^2 + 3n + 2}{n + 1}$이 
       자연수가 되는 모든 $n$의 값의 합을 구하여라.
해설: 식을 정리하면 $n + 2$가 되므로 모든 자연수 $n$에 대해 성립.
     하지만 문제 조건 재확인 필요... (이런 식의 해설 금지!)
     → 올바른 해설: 인수분해하면 $\\frac{(n+1)(n+2)}{n+1} = n+2$이므로 모든 자연수에서 성립.
```

**난이도 구분 핵심**
- A: 1~2단계 계산, 공식 직접 적용
- B: 3~4단계 풀이, 실생활 응용, 개념 2개 결합
- C: 5단계 이상, 창의적 접근, 여러 개념 통합

**절대 하지 말 것**
- A단계를 B나 C처럼 복잡하게 만들기
- C단계를 A나 B처럼 단순하게 만들기
- 모든 문제를 비슷한 난이도로 만들기
"""

    @staticmethod
    def get_json_format() -> str:
        """JSON 응답 형식 - KaTeX 최적화"""
        return """
**[JSON 응답 형식]**
```json
[
  {
    "question": "문제 내용 (KaTeX 수식 포함)",
    "choices": ["선택지1", "선택지2", "선택지3", "선택지4"],
    "correct_answer": "정답",
    "explanation": "간결한 해설",
    "problem_type": "multiple_choice/short_answer/essay",
    "difficulty": "A/B/C",
    "has_diagram": false,
    "diagram_type": null,
    "diagram_elements": null
  }
]
```

**필드별 상세 규칙**

1. **question**: 
   - 모든 수식은 $ 기호로 감싸기
   - 백슬래시는 반드시 이스케이프: \\frac, \\sqrt, \\times
   - 예: "방정식 $2x + 3 = 7$을 풀어라."

2. **choices** (객관식만):
   - 배열 형식: ["선택지1", "선택지2", "선택지3", "선택지4"]
   - 번호 표시 금지 (①②③④ X, 1) 2) 3) 4) X)
   - 수식 포함 시: ["$x = 1$", "$x = 2$", "$x = 3$", "$x = 4$"]

3. **correct_answer**:
   - 객관식: "A", "B", "C", "D" 중 하나
   - 단답형: "$x = 5$", "15", "$3x + 2$"
   - 서술형: 완전한 모범답안

4. **explanation**:
   - A단계: 1~2문장 (예: "$2x = 4$이므로 $x = 2$")
   - B단계: 2~3문장 (예: "거리는 속력×시간이다. 따라서 $60 \\times 2 = 120$km")
   - C단계: 3~4문장 (핵심 아이디어 + 주요 과정)

5. **difficulty**:
   - 반드시 "A", "B", "C" 중 하나
   - 요청된 분배 비율 정확히 준수

**KaTeX 렌더링 체크리스트**
✓ 모든 수식이 $로 감싸져 있는가?
✓ 분수는 \\frac{분자}{분모} 형식인가?
✓ 제곱은 ^{지수} 형식인가? (두 자리 이상)
✓ 백슬래시가 제대로 이스케이프 되었는가?
✓ 중괄호 { }가 빠지지 않았는가?
"""

    @staticmethod
    def build_problem_generation_prompt(
        curriculum_data: Dict,
        user_prompt: str,
        problem_count: int,
        difficulty_distribution: str,
        reference_problems: str
    ) -> str:
        """쎈 스타일 문제 생성 프롬프트"""
        return f"""당신은 대한민국 베스트셀러 수학 문제집 "쎈"의 출제 전문가입니다.
쎈 교재의 A단계(기본), B단계(유형), C단계(심화) 스타일로 문제를 생성하세요.

**교육과정**: {curriculum_data.get('grade')} {curriculum_data.get('semester')} - {curriculum_data.get('unit_name')} > {curriculum_data.get('chapter_name')}
**사용자 요청**: "{user_prompt}"
**생성할 문제 수**: {problem_count}개
**난이도 분배**: {difficulty_distribution}

**쎈 교재 스타일 핵심**:
- A단계: 개념 확인용 기본 문제 (정답률 80~90%)
- B단계: 유형별 응용 문제, 실생활 연계 (정답률 50~60%)
- C단계: 사고력 요구 심화 문제 (정답률 20~30%)

{PromptTemplates.get_difficulty_criteria()}

{reference_problems}

{PromptTemplates.get_generation_rules()}

{PromptTemplates.get_difficulty_requirements()}

{PromptTemplates.get_json_format()}

**최종 점검사항**:
1. 난이도 분배가 정확한가? (A:B:C 비율 확인)
2. KaTeX 수식이 올바른가? (\\frac, \\sqrt 등 이스케이프 확인)
3. 각 난이도별 문제 복잡도가 확실히 다른가?
4. 해설에 AI 사고과정이 노출되지 않았는가?
5. correct_answer 필드가 모든 문제에 정확히 입력되었는가?

JSON 배열로 {problem_count}개의 문제를 생성하세요."""

    @staticmethod
    def build_grading_prompt_essay(question: str, correct_answer: str, explanation: str, student_answer: str) -> str:
        """서술형 채점 프롬프트 - 쎈 스타일"""
        return f"""당신은 쎈 교재 스타일의 중학교 수학 채점 전문가입니다.
학생의 답안을 정확하고 교육적으로 평가해주세요.

**문제**: {question}
**모범답안**: {correct_answer}
**해설**: {explanation}

**학생 답안**: {student_answer}

**쎈 스타일 서술형 채점 기준**:
1. 최종 정답의 정확성 (40점)
   - 완전 정답: 40점
   - 부분 정답: 20점
   - 오답: 0점

2. 풀이 과정의 논리성 (40점)
   - 완벽한 논리 전개: 40점
   - 대체로 올바른 과정: 25~35점
   - 부분적으로 맞는 과정: 10~20점
   - 잘못된 접근: 0~5점

3. 수학적 표현의 정확성 (20점)
   - 수식, 기호 사용 정확: 20점
   - 사소한 표기 오류: 15점
   - 표현 미흡: 10점

**특별 규칙**:
- 과정 없이 답만 맞으면 최대 70점
- 계산 실수는 과정이 맞으면 -10점
- 창의적인 올바른 풀이는 가점 가능

응답 형식 (JSON):
{{
    "score": 점수(0-100),
    "is_correct": true/false,
    "feedback": "구체적이고 교육적인 피드백",
    "strengths": "잘한 부분 (구체적으로)",
    "improvements": "개선이 필요한 부분 (건설적으로)",
    "process_score": 과정점수(0-60),
    "answer_score": 정답점수(0-40)
}}"""

    @staticmethod
    def build_grading_prompt_objective(question: str, correct_answer: str, explanation: str, student_answer: str) -> str:
        """객관식/단답형 채점 프롬프트 - 쎈 스타일"""
        return f"""당신은 쎈 교재 스타일의 중학교 수학 채점 전문가입니다.
학생의 답안을 명확하게 평가해주세요.

**문제**: {question}
**정답**: {correct_answer}
**해설**: {explanation}

**학생 답안**: {student_answer}

**쎈 스타일 채점 기준**:
1. 정답 여부 (50점)
   - 정답: 50점
   - 오답: 0점

2. 풀이 과정 (30점) - 제시된 경우
   - 올바른 과정: 30점
   - 부분적 과정: 15점
   - 없거나 틀림: 0점

3. 계산 정확성 (20점)
   - 완벽한 계산: 20점
   - 사소한 실수: 10점
   - 중대한 오류: 0점

응답 형식 (JSON):
{{
    "score": 점수(0-100),
    "is_correct": true/false,
    "feedback": "명확하고 도움이 되는 피드백",
    "strengths": "잘한 점",
    "improvements": "보완할 점"
}}"""